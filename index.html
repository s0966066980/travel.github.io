<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morning Travel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 禁止選取與長按跳出選單，更像原生APP */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            overflow: hidden; /* 防止整體頁面捲動 */
        }

        /* 隱藏 Scrollbar 但保持捲動功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 跑馬燈動畫 */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background-color: #fee2e2; /* Red-100 */
            color: #b91c1c; /* Red-700 */
            display: flex;
            align-items: center;
            z-index: 20;
            border-bottom: 1px solid #fca5a5;
        }
        
        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
            font-weight: bold;
        }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        /* 左側導航欄激活狀態 */
        .nav-item.active {
            background-color: #dbeafe; /* Blue-100 */
            color: #2563eb; /* Blue-600 */
            border-right: 4px solid #2563eb;
        }

        /* 模擬 iOS 開關 */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }

        /* 圖片上傳預覽框 */
        .img-preview {
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="h-screen w-screen text-gray-800 flex flex-col">

    <!-- ==================== 頁面 1: 首頁 (Home) ==================== -->
    <div id="page-home" class="flex-1 flex flex-col h-full absolute inset-0 bg-gray-50 z-10 transition-transform duration-300">
        <!-- Header -->
        <header class="bg-white shadow px-4 py-4 flex justify-between items-center z-20">
            <h1 class="text-2xl font-bold text-blue-600 tracking-wider">Morning Travel</h1>
            <button onclick="openSettings()" class="text-gray-500 hover:text-blue-500 p-2">
                <i class="fa-solid fa-gear text-xl"></i>
            </button>
        </header>

        <!-- Trip List -->
        <div id="trip-list" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
            <!-- Trips will be injected here JS -->
            <div class="text-center text-gray-400 mt-20">
                <i class="fa-solid fa-plane-up text-6xl mb-4 opacity-30"></i>
                <p>還沒有行程，按下方按鈕新增！</p>
            </div>
        </div>

        <!-- Add Trip Button (FAB) -->
        <button onclick="openAddTripModal()" class="absolute bottom-8 right-6 bg-blue-600 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center text-2xl active:scale-95 transition-transform z-30">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <!-- ==================== 頁面 2: 行程詳細 (Detail Dashboard) ==================== -->
    <div id="page-detail" class="hidden flex-1 flex-col h-full absolute inset-0 bg-white z-20">
        <!-- Top Bar -->
        <div class="h-14 bg-white border-b flex items-center justify-between px-3 shadow-sm shrink-0 z-30">
            <button onclick="goHome()" class="text-gray-500 p-2">
                <i class="fa-solid fa-chevron-left"></i> 返回
            </button>
            <div class="text-center">
                <h2 id="detail-title" class="font-bold text-lg truncate max-w-[150px]">行程名稱</h2>
                <div class="text-xs text-gray-500" id="detail-dates">2024/01/01 - 5天</div>
            </div>
            <button onclick="openMap()" class="text-blue-500 p-2">
                <i class="fa-solid fa-map-location-dot text-xl"></i>
            </button>
        </div>

        <!-- Main Layout: Sidebar + Content -->
        <div class="flex flex-1 overflow-hidden relative">
            <!-- Left Sidebar (Fixed) -->
            <div class="w-20 bg-gray-100 border-r flex flex-col items-center py-4 space-y-6 shrink-0 z-20">
                <div onclick="switchTab('itinerary')" class="nav-item w-full py-3 flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600 active" id="nav-itinerary">
                    <i class="fa-solid fa-calendar-day text-xl mb-1"></i>
                    <span class="text-[10px]">行程</span>
                </div>
                <div onclick="switchTab('shopping')" class="nav-item w-full py-3 flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600" id="nav-shopping">
                    <i class="fa-solid fa-bag-shopping text-xl mb-1"></i>
                    <span class="text-[10px]">購物</span>
                </div>
                <div onclick="switchTab('packing')" class="nav-item w-full py-3 flex flex-col items-center cursor-pointer text-gray-500 hover:text-blue-600" id="nav-packing">
                    <i class="fa-solid fa-suitcase text-xl mb-1"></i>
                    <span class="text-[10px]">行李</span>
                </div>
            </div>

            <!-- Right Content Area -->
            <div class="flex-1 relative bg-white overflow-hidden">
                
                <!-- Section: Itinerary -->
                <div id="tab-itinerary" class="tab-content h-full overflow-y-auto no-scrollbar p-4 pb-20">
                    <div id="itinerary-days-container" class="space-y-6">
                        <!-- Days generated by JS -->
                    </div>
                </div>

                <!-- Section: Shopping -->
                <div id="tab-shopping" class="tab-content hidden h-full overflow-y-auto no-scrollbar pb-20">
                    <div class="p-3 bg-gray-50 border-b flex justify-between items-center sticky top-0 z-10">
                        <span class="text-sm font-bold text-gray-600">總花費: <span id="total-spend">NT$ 0</span></span>
                        <div class="flex items-center">
                            <span class="text-xs mr-2 text-gray-500">照片模式</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="view-mode-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 transition-all duration-300 right-5"/>
                                <label for="view-mode-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                    <div id="shopping-list-container" class="p-4 space-y-3">
                        <!-- Shopping items JS -->
                    </div>
                </div>

                <!-- Section: Packing -->
                <div id="tab-packing" class="tab-content hidden h-full overflow-y-auto no-scrollbar pt-12 pb-20 relative">
                    <!-- Marquee -->
                    <div id="marquee-banner" class="marquee-container hidden">
                        <div id="marquee-text" class="marquee-content">
                            還有行李沒帶喔！記得檢查清單！
                        </div>
                    </div>
                    
                    <div class="px-4 py-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700">行李清單</h3>
                            <button onclick="resetPacking()" class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">重置所有</button>
                        </div>
                        <div id="packing-list-container" class="space-y-2">
                            <!-- Packing items JS -->
                        </div>
                    </div>
                </div>

                <!-- Universal FAB for inside Detail View -->
                <button onclick="handleDetailFab()" class="absolute bottom-6 right-6 bg-blue-600 text-white rounded-full w-12 h-12 shadow-lg flex items-center justify-center text-xl active:scale-95 transition-transform z-40">
                    <i id="detail-fab-icon" class="fa-solid fa-plus"></i>
                </button>

            </div>
        </div>
    </div>

    <!-- ==================== Modals ==================== -->

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-10/12 max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">設定</h3>
            <div class="space-y-4">
                <div class="flex justify-between">
                    <span class="text-gray-600">版本</span>
                    <span class="font-mono text-blue-600">v1.2.0 (Oli Edition)</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">自動更新匯率</span>
                    <i class="fa-solid fa-toggle-on text-green-500 text-2xl"></i>
                </div>
                <div class="text-xs text-gray-400 mt-2">
                    目前匯率參考 (模擬):<br>
                    1 TWD = 4.6 JPY<br>
                    1 TWD = 0.031 USD<br>
                    1 TWD = 41.5 KRW
                </div>
            </div>
            <button onclick="closeModal('modal-settings')" class="mt-6 w-full bg-gray-200 text-gray-700 py-2 rounded-lg">關閉</button>
        </div>
    </div>

    <!-- Add Trip Modal -->
    <div id="modal-add-trip" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-10/12 max-w-sm p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold"><i class="fa-solid fa-plane text-blue-500 mr-2"></i>新增旅行</h3>
                <button onclick="closeModal('modal-add-trip')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="add-trip-form" onsubmit="saveNewTrip(event)">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">行程名稱</label>
                        <input type="text" id="trip-name" required placeholder="例如：東京五日遊" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">地點 (Google Map 連結用)</label>
                        <input type="text" id="trip-location" required placeholder="例如：日本東京" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600 mb-1">開始日期</label>
                            <input type="date" id="trip-start" required class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                        <div class="w-20">
                            <label class="block text-sm text-gray-600 mb-1">天數</label>
                            <input type="number" id="trip-duration" min="1" max="30" value="3" required class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg font-bold shadow hover:bg-blue-700">建立行程</button>
            </form>
        </div>
    </div>

    <!-- Add Shopping Item Modal -->
    <div id="modal-add-item" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-10/12 max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">新增購物清單</h3>
            <form id="add-item-form" onsubmit="saveShoppingItem(event)">
                <div class="space-y-3">
                    <input type="text" id="item-name" placeholder="商品名稱" required class="w-full border p-2 rounded">
                    <input type="text" id="item-place" placeholder="購買地點" class="w-full border p-2 rounded">
                    <div class="flex gap-2">
                        <select id="item-currency" class="border p-2 rounded bg-white w-1/3" onchange="calculateRate()">
                            <option value="TWD">TWD</option>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                            <option value="KRW">KRW</option>
                        </select>
                        <input type="number" id="item-price-twd" placeholder="台幣金額" class="border p-2 rounded w-2/3" oninput="calculateRate()">
                    </div>
                    <div class="text-xs text-gray-500 text-right" id="rate-preview">≈ 外幣 0</div>
                    <input type="file" id="item-image" accept="image/*" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('modal-add-item')" class="flex-1 bg-gray-200 py-2 rounded">取消</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded">新增</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Packing Item Modal -->
    <div id="modal-add-packing" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-10/12 max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">新增行李項目</h3>
            <form id="add-packing-form" onsubmit="savePackingItem(event)">
                <input type="text" id="pack-name" placeholder="例如：護照、充電器" required class="w-full border p-2 rounded mb-4">
                <div class="flex gap-2">
                    <button type="button" onclick="closeModal('modal-add-packing')" class="flex-1 bg-gray-200 py-2 rounded">取消</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded">新增</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Itinerary Event Modal -->
    <div id="modal-add-event" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-10/12 max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">新增行程</h3>
            <form id="add-event-form" onsubmit="saveItineraryEvent(event)">
                <input type="hidden" id="event-day-index">
                <div class="space-y-3">
                    <input type="time" id="event-time" required class="w-full border p-2 rounded">
                    <input type="text" id="event-title" placeholder="做什麼？(例如：吃拉麵)" required class="w-full border p-2 rounded">
                    <input type="text" id="event-location" placeholder="地點 (選填)" class="w-full border p-2 rounded">
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('modal-add-event')" class="flex-1 bg-gray-200 py-2 rounded">取消</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded">新增</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. State Management & Data ---
        let appData = {
            trips: [],
            rates: { TWD: 1, JPY: 4.6, USD: 0.031, KRW: 41.5, EUR: 0.029 } // 模擬匯率: 1 TWD 等於多少外幣
        };

        let currentTripId = null;
        let currentTab = 'itinerary';

        function loadData() {
            const stored = localStorage.getItem('morningTravelData_v1');
            if (stored) {
                appData = JSON.parse(stored);
            }
            renderTripList();
        }

        function saveData() {
            localStorage.setItem('morningTravelData_v1', JSON.stringify(appData));
        }

        // --- 2. Navigation Logic ---
        function openSettings() { document.getElementById('modal-settings').classList.remove('hidden'); document.getElementById('modal-settings').classList.add('flex'); }
        function openAddTripModal() { document.getElementById('modal-add-trip').classList.remove('hidden'); document.getElementById('modal-add-trip').classList.add('flex'); }
        
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        function goHome() {
            document.getElementById('page-detail').classList.add('hidden');
            document.getElementById('page-detail').classList.remove('flex');
            document.getElementById('page-home').classList.remove('hidden');
            currentTripId = null;
        }

        function openMap() {
            const trip = appData.trips.find(t => t.id === currentTripId);
            if (trip) {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(trip.location)}`, '_blank');
            }
        }

        // --- 3. Home Screen Logic ---
        function saveNewTrip(e) {
            e.preventDefault();
            const name = document.getElementById('trip-name').value;
            const location = document.getElementById('trip-location').value;
            const start = document.getElementById('trip-start').value;
            const duration = parseInt(document.getElementById('trip-duration').value);

            const newTrip = {
                id: Date.now(),
                name,
                location,
                start,
                duration,
                itinerary: {}, // Key: dayIndex (0-based), Value: Array of events
                shopping: [],
                packing: [
                    {id: 1, name: "護照", checked: false},
                    {id: 2, name: "錢包", checked: false},
                    {id: 3, name: "手機充電器", checked: false},
                    {id: 4, name: "換洗衣物", checked: false}
                ]
            };
            
            // Init empty days
            for(let i=0; i<duration; i++) newTrip.itinerary[i] = [];

            appData.trips.push(newTrip);
            saveData();
            closeModal('modal-add-trip');
            renderTripList();
            document.getElementById('add-trip-form').reset();
        }

        function renderTripList() {
            const container = document.getElementById('trip-list');
            container.innerHTML = '';
            
            if (appData.trips.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-20"><i class="fa-solid fa-plane-up text-6xl mb-4 opacity-30"></i><p>還沒有行程，按下方按鈕新增！</p></div>`;
                return;
            }

            // 反轉順序，新的在上面
            [...appData.trips].reverse().forEach(trip => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50 transition';
                el.innerHTML = `
                    <div onclick="enterTrip(${trip.id})" class="flex-1 cursor-pointer">
                        <h3 class="font-bold text-lg text-gray-800">${trip.name}</h3>
                        <div class="text-sm text-gray-500 mt-1">
                            <i class="fa-solid fa-location-dot mr-1 text-blue-400"></i> ${trip.location}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${trip.start} <span class="mx-1">•</span> ${trip.duration} 天
                        </div>
                    </div>
                    <button onclick="deleteTrip(${trip.id})" class="text-gray-300 hover:text-red-500 p-2 ml-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                container.appendChild(el);
            });
        }

        function deleteTrip(id) {
            if(confirm('確定要刪除這個行程嗎？')) {
                appData.trips = appData.trips.filter(t => t.id !== id);
                saveData();
                renderTripList();
            }
        }

        // --- 4. Detail View Logic ---
        function enterTrip(id) {
            currentTripId = id;
            const trip = appData.trips.find(t => t.id === id);
            
            document.getElementById('detail-title').innerText = trip.name;
            document.getElementById('detail-dates').innerText = `${trip.start} • ${trip.duration}天`;
            
            document.getElementById('page-home').classList.add('hidden');
            document.getElementById('page-detail').classList.remove('hidden');
            document.getElementById('page-detail').classList.add('flex');

            switchTab('itinerary');
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // UI Toggles
            ['itinerary', 'shopping', 'packing'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('active');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('active');

            // Render Content
            if(tab === 'itinerary') renderItinerary();
            if(tab === 'shopping') renderShopping();
            if(tab === 'packing') renderPacking();

            // Update FAB Action
            updateFab();
        }

        function updateFab() {
            const fab = document.getElementById('detail-fab-icon');
            if (currentTab === 'itinerary') fab.className = 'fa-solid fa-calendar-plus';
            else if (currentTab === 'shopping') fab.className = 'fa-solid fa-cart-plus';
            else if (currentTab === 'packing') fab.className = 'fa-solid fa-plus';
        }

        function handleDetailFab() {
            if (currentTab === 'itinerary') {
                // Default add to Day 1 for simplicity in FAB, or prompt. 
                // Better UX: FAB in itinerary adds a new DAY or is just not used, 
                // but user asked for unified FAB. Let's make it add to "Day 1" or open modal with day selector.
                // For this implementation, let's open modal and assume user picks day inside (which I will add to modal logic).
                openAddEventModal(0); // Default to day 0
            } else if (currentTab === 'shopping') {
                document.getElementById('add-item-form').reset();
                document.getElementById('rate-preview').innerText = '≈ 外幣 0';
                document.getElementById('modal-add-item').classList.remove('hidden');
                document.getElementById('modal-add-item').classList.add('flex');
            } else if (currentTab === 'packing') {
                document.getElementById('add-packing-form').reset();
                document.getElementById('modal-add-packing').classList.remove('hidden');
                document.getElementById('modal-add-packing').classList.add('flex');
            }
        }

        // --- 5. Itinerary Logic ---
        function renderItinerary() {
            const trip = appData.trips.find(t => t.id === currentTripId);
            const container = document.getElementById('itinerary-days-container');
            container.innerHTML = '';

            let startDate = new Date(trip.start);

            for (let i = 0; i < trip.duration; i++) {
                let currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                let dateStr = currentDate.toISOString().split('T')[0].slice(5).replace('-', '/');

                const dayEvents = trip.itinerary[i] || [];
                
                // Sort events by time
                dayEvents.sort((a,b) => a.time.localeCompare(b.time));

                let eventsHtml = dayEvents.map((evt, idx) => `
                    <div class="flex items-start mt-3 relative group">
                        <div class="w-12 text-xs text-gray-500 font-mono pt-1 text-right pr-2">${evt.time}</div>
                        <div class="flex-1 bg-blue-50 p-2 rounded-lg border-l-4 border-blue-400">
                            <div class="font-bold text-gray-700 text-sm">${evt.title}</div>
                            ${evt.location ? `<div onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.location)}')" class="text-xs text-blue-500 mt-1 cursor-pointer truncate"><i class="fa-solid fa-map-pin"></i> ${evt.location}</div>` : ''}
                        </div>
                        <button onclick="deleteEvent(${i}, ${idx})" class="absolute right-1 top-1 text-gray-300 hover:text-red-500 p-1"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                `).join('');

                const dayEl = document.createElement('div');
                dayEl.innerHTML = `
                    <div class="mb-2 flex items-baseline justify-between border-b pb-1">
                        <h4 class="font-bold text-xl text-gray-800">Day ${i+1} <span class="text-sm font-normal text-gray-500 ml-2">${dateStr}</span></h4>
                        <button onclick="openAddEventModal(${i})" class="text-blue-500 text-sm bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">+ 新增</button>
                    </div>
                    <div>${eventsHtml.length ? eventsHtml : '<div class="text-xs text-gray-300 italic py-2 pl-12">無行程</div>'}</div>
                `;
                container.appendChild(dayEl);
            }
        }

        let currentEditingDay = 0;
        function openAddEventModal(dayIndex) {
            currentEditingDay = dayIndex;
            document.getElementById('event-day-index').value = dayIndex;
            document.getElementById('modal-add-event').classList.remove('hidden');
            document.getElementById('modal-add-event').classList.add('flex');
        }

        function saveItineraryEvent(e) {
            e.preventDefault();
            const time = document.getElementById('event-time').value;
            const title = document.getElementById('event-title').value;
            const location = document.getElementById('event-location').value;

            const trip = appData.trips.find(t => t.id === currentTripId);
            if (!trip.itinerary[currentEditingDay]) trip.itinerary[currentEditingDay] = [];
            
            trip.itinerary[currentEditingDay].push({ time, title, location });
            
            saveData();
            closeModal('modal-add-event');
            document.getElementById('add-event-form').reset();
            renderItinerary();
        }

        function deleteEvent(dayIdx, eventIdx) {
            if(confirm('刪除此行程？')) {
                const trip = appData.trips.find(t => t.id === currentTripId);
                trip.itinerary[dayIdx].splice(eventIdx, 1);
                saveData();
                renderItinerary();
            }
        }

        // --- 6. Shopping Logic ---
        function calculateRate() {
            const currency = document.getElementById('item-currency').value;
            const twd = parseFloat(document.getElementById('item-price-twd').value) || 0;
            const rate = appData.rates[currency] || 1;
            // 需求：輸入台幣金額自動換算
            // 邏輯：台幣 1000 元，在日本(匯率4.6) = 4600 日幣
            const foreign = (twd * rate).toFixed(2);
            document.getElementById('rate-preview').innerText = `≈ ${currency} ${foreign}`;
        }

        function saveShoppingItem(e) {
            e.preventDefault();
            const name = document.getElementById('item-name').value;
            const place = document.getElementById('item-place').value;
            const currency = document.getElementById('item-currency').value;
            const priceTwd = parseInt(document.getElementById('item-price-twd').value) || 0;
            const fileInput = document.getElementById('item-image');
            
            // 處理圖片 (簡單轉Base64，注意Localstorage限制)
            let imgData = null;
            
            const processSave = (img) => {
                const trip = appData.trips.find(t => t.id === currentTripId);
                trip.shopping.push({
                    id: Date.now(),
                    name,
                    place,
                    currency,
                    priceTwd,
                    image: img
                });
                saveData();
                closeModal('modal-add-item');
                renderShopping();
            }

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processSave(e.target.result);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                processSave(null);
            }
        }

        function renderShopping() {
            const trip = appData.trips.find(t => t.id === currentTripId);
            const container = document.getElementById('shopping-list-container');
            const isPhotoMode = document.getElementById('view-mode-toggle').checked;
            container.innerHTML = '';

            // Calculate total
            const total = trip.shopping.reduce((sum, item) => sum + item.priceTwd, 0);
            document.getElementById('total-spend').innerText = `NT$ ${total.toLocaleString()}`;

            if (isPhotoMode) {
                // Photo Mode (Grid)
                container.className = 'grid grid-cols-2 gap-3 p-4';
                trip.shopping.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 rounded-lg shadow overflow-hidden relative group aspect-square flex flex-col';
                    const bgStyle = item.image ? `background-image: url('${item.image}')` : 'background-color: #e5e7eb';
                    
                    el.innerHTML = `
                        <div class="flex-1 img-preview relative" style="${bgStyle}">
                             ${!item.image ? '<div class="absolute inset-0 flex items-center justify-center text-gray-400"><i class="fa-solid fa-image text-2xl"></i></div>' : ''}
                             <button onclick="deleteShoppingItem(${item.id})" class="absolute top-1 right-1 bg-black bg-opacity-50 text-white rounded-full w-6 h-6 flex items-center justify-center"><i class="fa-solid fa-xmark text-xs"></i></button>
                        </div>
                        <div class="p-2 bg-white text-xs">
                            <div class="font-bold truncate">${item.name}</div>
                            <div class="text-gray-500">NT$ ${item.priceTwd}</div>
                        </div>
                    `;
                    container.appendChild(el);
                });
            } else {
                // List Mode
                container.className = 'p-4 space-y-3';
                trip.shopping.forEach(item => {
                    // Right swipe deletion simulation using a button for web compatibility
                    const el = document.createElement('div');
                    el.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex items-center justify-between';
                    el.innerHTML = `
                        <div class="flex items-center space-x-3 overflow-hidden">
                            <div class="w-10 h-10 rounded bg-gray-200 bg-cover bg-center shrink-0" style="background-image: url('${item.image || ''}')">
                                ${!item.image ? '<i class="fa-solid fa-bag-shopping text-gray-400 mt-3 ml-3 text-sm"></i>' : ''}
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-sm text-gray-800 truncate">${item.name}</h4>
                                <div class="text-xs text-gray-500"><i class="fa-solid fa-location-dot"></i> ${item.place || '未知'}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="text-right mr-3">
                                <div class="font-bold text-blue-600 text-sm">NT$${item.priceTwd}</div>
                                <div class="text-[10px] text-gray-400">${item.currency}</div>
                            </div>
                            <button onclick="deleteShoppingItem(${item.id})" class="text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }
        }

        document.getElementById('view-mode-toggle').addEventListener('change', renderShopping);

        function deleteShoppingItem(id) {
            if(confirm('刪除此商品？')) {
                const trip = appData.trips.find(t => t.id === currentTripId);
                trip.shopping = trip.shopping.filter(i => i.id !== id);
                saveData();
                renderShopping();
            }
        }

        // --- 7. Packing Logic ---
        function savePackingItem(e) {
            e.preventDefault();
            const name = document.getElementById('pack-name').value;
            const trip = appData.trips.find(t => t.id === currentTripId);
            trip.packing.push({ id: Date.now(), name, checked: false });
            saveData();
            closeModal('modal-add-packing');
            renderPacking();
        }

        function togglePackItem(id) {
            const trip = appData.trips.find(t => t.id === currentTripId);
            const item = trip.packing.find(i => i.id === id);
            if(item) {
                item.checked = !item.checked;
                saveData();
                renderPacking(); // Re-render to update marquee
            }
        }

        function deletePackItem(id) {
            const trip = appData.trips.find(t => t.id === currentTripId);
            trip.packing = trip.packing.filter(i => i.id !== id);
            saveData();
            renderPacking();
        }

        function resetPacking() {
            if(confirm('重置所有勾選狀態？')) {
                const trip = appData.trips.find(t => t.id === currentTripId);
                trip.packing.forEach(i => i.checked = false);
                saveData();
                renderPacking();
            }
        }

        function renderPacking() {
            const trip = appData.trips.find(t => t.id === currentTripId);
            const container = document.getElementById('packing-list-container');
            container.innerHTML = '';

            // Update Marquee
            const unchecked = trip.packing.filter(i => !i.checked);
            const marqueeContainer = document.getElementById('marquee-banner');
            const marqueeText = document.getElementById('marquee-text');

            if (unchecked.length > 0) {
                marqueeContainer.classList.remove('hidden');
                // 重複字串讓跑馬燈看起來更長
                const text = "⚠️ 還沒帶： " + unchecked.map(i => i.name).join('、') + " ";
                marqueeText.innerText = text + text + text; 
                // Adjust container padding to accommodate marquee
                document.getElementById('tab-packing').classList.add('pt-12');
                document.getElementById('tab-packing').classList.remove('pt-4');
            } else {
                marqueeContainer.classList.add('hidden');
                document.getElementById('tab-packing').classList.remove('pt-12');
                document.getElementById('tab-packing').classList.add('pt-4');
            }

            trip.packing.forEach(item => {
                const el = document.createElement('div');
                el.className = `flex items-center justify-between p-3 rounded-lg border ${item.checked ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`;
                el.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1" onclick="togglePackItem(${item.id})">
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition ${item.checked ? 'border-green-500 bg-green-500 text-white' : 'border-gray-300 text-transparent'}">
                            <i class="fa-solid fa-check text-xs"></i>
                        </div>
                        <span class="${item.checked ? 'text-gray-400 line-through' : 'text-gray-800 font-medium'}">${item.name}</span>
                    </div>
                    <button onclick="deletePackItem(${item.id})" class="text-gray-300 hover:text-red-500 px-2">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                container.appendChild(el);
            });
        }

        // Init
        window.onload = loadData;

    </script>
</body>
</html>

