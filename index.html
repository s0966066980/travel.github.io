<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelFlow 8.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-main: #0d9488;
            --color-light: #f0fdfa;
            --color-bg: #f3f4f6;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg);
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Utility */
        .text-theme { color: var(--color-main); }
        .bg-theme { background-color: var(--color-main); }
        .bg-theme-light { background-color: var(--color-light); }
        .border-theme { border-color: var(--color-main); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: var(--safe-bottom); }

        /* Timeline Graphics */
        .timeline-line {
            position: absolute;
            left: 19px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }

        /* Swipe Actions */
        .swipe-item-container {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }
        .swipe-content {
            position: relative;
            z-index: 10;
            background: white;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        .swipe-action-bg {
            position: absolute;
            inset: 0;
            background-color: #ef4444;
            z-index: 1;
            display: flex;
            align-items: center;
            padding-left: 1.5rem;
            border-radius: 0.75rem;
        }
        
        .modal-body-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Active Item Pulse */
        @keyframes pulse-border {
            0% { border-color: var(--color-main); box-shadow: 0 0 0 0 rgba(13, 148, 136, 0.4); }
            70% { border-color: var(--color-main); box-shadow: 0 0 0 6px rgba(13, 148, 136, 0); }
            100% { border-color: var(--color-main); box-shadow: 0 0 0 0 rgba(13, 148, 136, 0); }
        }
        .active-item-card {
            border-left: 4px solid var(--color-main) !important;
            animation: pulse-border 2s infinite;
        }

        /* PDF Export Styles (Hidden from screen) */
        #pdf-export-container {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 800px; /* Fixed width for A4 consistency */
            background: white;
            padding: 40px;
            font-family: 'Noto Sans TC', sans-serif;
            color: #333;
        }
        .pdf-day-header {
            background-color: #f0fdfa;
            color: #0d9488;
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            border-left: 5px solid #0d9488;
        }
        .pdf-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
            page-break-inside: avoid;
        }
        .pdf-page-break {
            page-break-before: always;
        }
    </style>
</head>
<body>

    <!-- App Container -->
    <div id="app" class="w-full h-full bg-white flex flex-col relative overflow-hidden">
        
        <!-- ==================== VIEW: HOME ==================== -->
        <div id="view-home" class="flex-1 flex flex-col w-full h-full absolute inset-0 bg-gray-50 z-10 transition-transform duration-300">
            <header class="bg-white p-4 shadow-sm z-20 flex justify-between items-center shrink-0">
                <div>
                    <h1 class="text-2xl font-bold text-theme flex items-center gap-2">
                        <i data-lucide="plane" class="w-6 h-6"></i> TravelFlow
                    </h1>
                    <p class="text-xs text-gray-500 mt-0.5">Oli & Ê£†Ê£†ÁöÑÊóÖË°å (v8.0)</p>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Current Location Weather -->
                    <div id="current-weather-badge" class="hidden flex flex-col items-end mr-1">
                        <div class="flex items-center gap-1 text-gray-600">
                            <i id="current-weather-icon" data-lucide="cloud" class="w-4 h-4 weather-icon"></i>
                            <span id="current-temp" class="text-sm font-bold">--¬∞C</span>
                        </div>
                        <span class="text-[10px] text-gray-400">ÁõÆÂâç‰ΩçÁΩÆ</span>
                    </div>

                    <button onclick="openSettings()" class="p-2 text-gray-400 hover:text-theme transition rounded-full active:bg-gray-100">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 w-full max-w-2xl mx-auto" id="trip-list-container">
                <!-- Trip cards injected here -->
            </div>

            <div class="p-4 bg-white border-t border-gray-100 shrink-0 pb-safe">
                <button onclick="openAddTripModal()" class="w-full max-w-2xl mx-auto bg-theme text-white font-medium py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transition active:scale-95">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Êñ∞Â¢ûÊóÖË°å
                </button>
            </div>
        </div>

        <!-- ==================== VIEW: DETAIL ==================== -->
        <div id="view-detail" class="flex-1 flex flex-col w-full h-full absolute inset-0 bg-white z-20 translate-x-full transition-transform duration-300">
            <!-- Header -->
            <header class="bg-theme text-white p-3 shadow-md z-30 shrink-0 relative overflow-hidden">
                <div class="flex items-center justify-between mb-2 relative z-10">
                    <button onclick="goBack()" class="p-2 -ml-1 rounded-full active:bg-white/20 transition">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <div class="text-center flex-1 mx-2 overflow-hidden px-2">
                        <div class="flex items-center justify-center gap-2">
                            <h2 id="detail-title" class="font-bold text-lg truncate leading-tight">Title</h2>
                            <div id="dest-weather-badge" class="hidden flex items-center gap-1 bg-white/20 px-1.5 py-0.5 rounded-md backdrop-blur-sm">
                                <span id="dest-temp" class="text-xs font-bold">--¬∞</span>
                                <i id="dest-weather-icon" data-lucide="sun" class="w-3 h-3 text-yellow-300"></i>
                            </div>
                        </div>
                        <span id="detail-cost" class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full inline-block mt-0.5 font-mono">Á∏ΩËä±Ë≤ª: NT$ 0</span>
                    </div>
                    <button onclick="exportFullPDF()" class="p-2 -mr-1 rounded-full active:bg-white/20 transition" title="ÂåØÂá∫ÂÆåÊï¥Ë°åÁ®ãPDF">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                    </button>
                </div>
                <!-- Tabs -->
                <div class="flex bg-black/10 rounded-lg p-1 max-w-md mx-auto w-full relative z-10">
                    <button onclick="switchTab('itinerary')" id="tab-itinerary" class="flex-1 py-1.5 text-xs font-medium rounded-md bg-white text-theme shadow-sm transition">Ë°åÁ®ã</button>
                    <button onclick="switchTab('shopping')" id="tab-shopping" class="flex-1 py-1.5 text-xs font-medium rounded-md text-white/80 transition">Ë®òÂ∏≥ & Ë≥ºÁâ©</button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 overflow-hidden relative w-full mx-auto bg-gray-50">
                
                <!-- Tab: Itinerary -->
                <div id="content-itinerary" class="absolute inset-0 overflow-y-auto bg-gray-50 pb-20 scroll-smooth w-full max-w-3xl mx-auto">
                    <!-- Day Selector -->
                    <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-20 shadow-sm border-b border-gray-100">
                        <div class="flex overflow-x-auto no-scrollbar p-2 gap-2" id="day-selector">
                            <!-- Days injected here -->
                        </div>
                    </div>

                    <div id="timeline-container" class="p-4 relative min-h-[300px]">
                        <!-- Timeline items injected here -->
                    </div>

                    <!-- Empty State -->
                    <div id="timeline-empty" class="hidden flex flex-col items-center justify-center mt-20 text-gray-400">
                        <i data-lucide="map-pin" class="w-12 h-12 mb-2 opacity-30"></i>
                        <p class="text-sm">Â∞öÊú™Êñ∞Â¢ûË°åÁ®ã</p>
                    </div>
                </div>

                <!-- Tab: Shopping (Fixed Layout) -->
                <div id="content-shopping" class="absolute inset-0 overflow-y-auto bg-gray-50 hidden p-4 pb-20 w-full">
                    <div class="w-full max-w-lg mx-auto"> <!-- Centered Container with max-width -->
                        <div class="bg-yellow-50 text-yellow-700 text-xs p-3 rounded-xl mb-4 flex items-start gap-2 border border-yellow-100 shadow-sm">
                            <i data-lucide="coins" class="w-4 h-4 shrink-0 mt-0.5"></i>
                            <p>ÂåØÁéáÂ∑≤Âç≥ÊôÇÊõ¥Êñ∞„ÄÇËº∏ÂÖ•Â§ñÂπ£ÈáëÈ°çÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÊèõÁÆóÁÇ∫Âè∞Âπ£Áµ±Ë®à„ÄÇ</p>
                        </div>

                        <!-- Fixed Layout Input Group -->
                        <div class="mb-4 flex w-full gap-2">
                            <input type="text" id="new-shop-item" placeholder="Ëº∏ÂÖ•Áâ©ÂìÅÂêçÁ®±..." class="flex-1 min-w-0 p-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 border-theme shadow-sm">
                            <button onclick="addShopItem()" class="bg-theme text-white px-5 rounded-lg shadow-sm font-bold text-xl active:scale-95 transition shrink-0 flex items-center justify-center">+</button>
                        </div>

                        <div id="shopping-list" class="space-y-3 w-full">
                            <!-- Shopping items -->
                        </div>

                        <div id="shopping-empty" class="hidden flex flex-col items-center justify-center mt-20 text-gray-400">
                            <i data-lucide="shopping-cart" class="w-12 h-12 mb-2 opacity-30"></i>
                            <p class="text-sm">Ê∏ÖÂñÆÊòØÁ©∫ÁöÑ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Action Button -->
            <div id="fab-container" class="absolute bottom-6 right-6 z-40 pb-safe">
                <button onclick="openAddItemModal()" class="bg-theme text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition active:scale-90 active:rotate-90">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Container for PDF Export -->
    <div id="pdf-export-container">
        <!-- Content will be injected here dynamically -->
    </div>

    <!-- ==================== MODALS ==================== -->
    
    <!-- Modal: Settings (Rates) -->
    <div id="modal-settings" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl modal-body-scroll max-h-[85vh]">
            <h3 class="text-lg font-bold text-gray-800 mb-4">APP Ë®≠ÂÆö</h3>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">‰∏ªÈ°åÈ°èËâ≤</label>
                <div class="flex gap-4 justify-center">
                    <button onclick="setTheme('teal')" class="w-10 h-10 rounded-full bg-teal-600 ring-2 ring-transparent focus:ring-teal-200"></button>
                    <button onclick="setTheme('rose')" class="w-10 h-10 rounded-full bg-rose-500 ring-2 ring-transparent focus:ring-rose-200"></button>
                    <button onclick="setTheme('blue')" class="w-10 h-10 rounded-full bg-blue-600 ring-2 ring-transparent focus:ring-blue-200"></button>
                </div>
            </div>

            <div class="mb-6 border-t border-gray-100 pt-4">
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide">ÂåØÁéáË®≠ÂÆö (Â∞çÂè∞Âπ£)</label>
                    <button onclick="fetchRealTimeRates()" class="text-[10px] bg-gray-100 px-2 py-1 rounded text-theme hover:bg-gray-200 flex items-center gap-1">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> Êõ¥Êñ∞
                    </button>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="w-12 font-bold text-gray-600">JPY</span>
                        <input type="number" id="rate-JPY" step="0.001" onchange="updateRate('JPY', this.value)" class="w-24 p-1 bg-gray-50 border rounded text-right">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="w-12 font-bold text-gray-600">USD</span>
                        <input type="number" id="rate-USD" step="0.1" onchange="updateRate('USD', this.value)" class="w-24 p-1 bg-gray-50 border rounded text-right">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="w-12 font-bold text-gray-600">KRW</span>
                        <input type="number" id="rate-KRW" step="0.001" onchange="updateRate('KRW', this.value)" class="w-24 p-1 bg-gray-50 border rounded text-right">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="w-12 font-bold text-gray-600">EUR</span>
                        <input type="number" id="rate-EUR" step="0.1" onchange="updateRate('EUR', this.value)" class="w-24 p-1 bg-gray-50 border rounded text-right">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="w-12 font-bold text-gray-600">HKD</span>
                        <input type="number" id="rate-HKD" step="0.1" onchange="updateRate('HKD', this.value)" class="w-24 p-1 bg-gray-50 border rounded text-right">
                    </div>
                </div>
            </div>

            <button onclick="closeModal('modal-settings')" class="w-full py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200">ÂÆåÊàê</button>
        </div>
    </div>

    <!-- Modal: Add Trip -->
    <div id="modal-trip" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl flex flex-col max-h-[80vh]">
            <h3 class="text-lg font-bold mb-4 text-gray-800 shrink-0">Âª∫Á´ãÊñ∞ÊóÖË°å</h3>
            <div class="space-y-4 modal-body-scroll">
                <input type="text" id="input-trip-name" placeholder="ÊóÖË°åÂêçÁ®± (Â¶Ç: Êù±‰∫¨‰∫îÊó•ÈÅä)" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 border-theme">
                <input type="text" id="input-trip-city" placeholder="‰∏ªË¶ÅÂüéÂ∏Ç (Ëã±Êñá, È°ØÁ§∫Â§©Ê∞£Áî®, Â¶Ç: Tokyo)" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 border-theme">
                <input type="date" id="input-trip-date" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 border-theme">
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-xl">
                    <button onclick="adjustDays(-1)" class="w-10 h-10 rounded-lg bg-white shadow-sm font-bold text-gray-500 active:scale-95">-</button>
                    <span id="display-days-count" class="font-bold text-xl">3 Â§©</span>
                    <button onclick="adjustDays(1)" class="w-10 h-10 rounded-lg bg-white shadow-sm font-bold text-gray-500 active:scale-95">+</button>
                </div>
            </div>
            <div class="mt-4 flex gap-3 shrink-0">
                <button onclick="closeModal('modal-trip')" class="flex-1 py-3 text-gray-500 bg-gray-100 rounded-xl font-medium">ÂèñÊ∂à</button>
                <button onclick="saveNewTrip()" class="flex-1 py-3 bg-theme text-white rounded-xl font-medium shadow-lg">Âª∫Á´ã</button>
            </div>
        </div>
    </div>

    <!-- Modal: Item -->
    <div id="modal-item" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-md sm:rounded-2xl shadow-2xl flex flex-col animate-slide-up">
            <div class="flex justify-between items-center p-4 border-b border-gray-100 shrink-0">
                <h3 id="modal-item-title" class="text-lg font-bold text-gray-800">Ë°åÁ®ãÁ¥∞ÁØÄ</h3>
                <button onclick="closeModal('modal-item')" class="p-1 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button>
            </div>
            
            <div class="p-5 modal-body-scroll space-y-5">
                <div class="flex gap-3">
                    <div class="w-1/3">
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">ÊôÇÈñì</label>
                        <input type="time" id="item-time" class="w-full p-3 bg-gray-50 rounded-xl outline-none">
                    </div>
                    <div class="w-2/3">
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">È°ûÂûã</label>
                        <select id="item-type" class="w-full p-3 bg-gray-50 rounded-xl outline-none appearance-none bg-white border border-gray-200">
                            <option value="spot">üìç ÊôØÈªû</option>
                            <option value="food">üç¥ È§êÂª≥</option>
                            <option value="transport">üöå ‰∫§ÈÄö</option>
                            <option value="stay">üõèÔ∏è ‰ΩèÂÆø</option>
                            <option value="flight">‚úàÔ∏è Ëà™Áè≠</option>
                        </select>
                    </div>
                </div>

                <div class="p-4 border border-gray-100 rounded-2xl relative shadow-sm">
                    <span class="absolute -top-2.5 left-3 bg-white px-1 text-xs font-bold text-theme">‰∏ªË¶ÅË°åÁ®ã Plan A</span>
                    <input type="text" id="item-title" placeholder="Ë¶ÅÂÅö‰ªÄÈ∫ºÔºü" class="w-full p-2 mb-2 font-medium text-lg border-b border-gray-100 outline-none placeholder-gray-300">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 shrink-0"></i>
                        <input type="text" id="item-location" placeholder="Google Maps Âú∞Èªû" class="w-full p-1 text-sm outline-none">
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Currency Selector -->
                        <select id="item-currency" class="text-xs font-bold text-gray-500 bg-gray-100 rounded p-1 outline-none">
                            <option value="TWD">TWD</option>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                            <option value="KRW">KRW</option>
                            <option value="EUR">EUR</option>
                            <option value="HKD">HKD</option>
                        </select>
                        <input type="number" id="item-cost" placeholder="Ë≤ªÁî®" class="w-full p-1 text-sm outline-none">
                    </div>
                </div>

                <div class="border border-dashed border-gray-300 rounded-2xl p-4 bg-gray-50">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 text-sm font-bold text-gray-600">
                            <input type="checkbox" id="has-plan-b" onchange="togglePlanBInputs()" class="w-5 h-5 accent-current text-theme rounded">
                            ÂïüÁî®ÂÇôÊ°à (Plan B)
                        </label>
                    </div>
                    
                    <div id="plan-b-inputs" class="hidden space-y-3 mt-3 pt-3 border-t border-gray-200">
                        <input type="text" id="backup-title" placeholder="ÂÇôÊ°àÊ®ôÈ°å..." class="w-full p-2 bg-white rounded-lg text-sm border border-gray-200 shadow-sm">
                        <div class="flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 shrink-0"></i>
                            <input type="text" id="backup-location" placeholder="ÂÇôÊ°àÂú∞Èªû" class="w-full p-1 bg-transparent text-sm outline-none">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">ÂÇôË®ª</label>
                    <textarea id="item-note" rows="3" placeholder="Ë©≥Á¥∞Ë≥áË®ä..." class="w-full p-3 bg-gray-50 rounded-xl outline-none resize-none text-sm"></textarea>
                </div>
                <div class="h-4"></div>
            </div>

            <div class="p-4 border-t border-gray-100 bg-white pb-safe shrink-0">
                <button onclick="saveItem()" class="w-full py-3.5 bg-theme text-white font-bold rounded-xl shadow-lg active:scale-95 transition">ÂÑ≤Â≠òË°åÁ®ã</button>
            </div>
        </div>
    </div>

    <script>
        // --- Init & Config ---
        const THEMES = {
            teal: { main: '#0d9488', light: '#f0fdfa' },
            rose: { main: '#e11d48', light: '#fff1f2' },
            blue: { main: '#2563eb', light: '#eff6ff' }
        };

        // Default Exchange Rates (Fallback)
        let defaultRates = {
            TWD: 1,
            JPY: 0.22,
            USD: 31.5,
            KRW: 0.024,
            EUR: 34.2,
            HKD: 4.05
        };

        let trips = JSON.parse(localStorage.getItem('travelFlow_trips_v8')) || [];
        let appSettings = JSON.parse(localStorage.getItem('travelFlow_settings_v8')) || { theme: 'teal', rates: defaultRates };
        let currentTripId = null;
        let currentDayIndex = 0;
        let tempDaysCount = 3;
        let editingItemId = null;
        let liveTrackerInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(appSettings.theme);
            lucide.createIcons();
            renderHome();
            document.getElementById('input-trip-date').valueAsDate = new Date();
            loadRatesToModal();
            fetchCurrentLocationWeather();
            // Fetch rates immediately on load
            fetchRealTimeRates();
        });

        // --- Currency Logic (Real-time API) ---
        async function fetchRealTimeRates() {
            try {
                // Using a public free API for demonstration
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                const data = await res.json();
                
                if (data && data.rates) {
                    // Update settings. Note: API gives TWD base, so rate is 1 TWD = X Foreign
                    // We need Foreign -> TWD value (e.g. 1 USD = 30 TWD).
                    // API: 1 TWD = 0.031 USD. So 1 USD = 1/0.031 TWD.
                    
                    appSettings.rates.JPY = 1 / data.rates.JPY;
                    appSettings.rates.USD = 1 / data.rates.USD;
                    appSettings.rates.KRW = 1 / data.rates.KRW;
                    appSettings.rates.EUR = 1 / data.rates.EUR;
                    appSettings.rates.HKD = 1 / data.rates.HKD;
                    
                    localStorage.setItem('travelFlow_settings_v8', JSON.stringify(appSettings));
                    loadRatesToModal();
                    updateCostDisplay();
                    console.log('Rates updated');
                }
            } catch (e) {
                console.error("Rate fetch failed, using stored/default", e);
            }
        }

        function loadRatesToModal() {
            if(!appSettings.rates) appSettings.rates = defaultRates;
            document.getElementById('rate-JPY').value = parseFloat(appSettings.rates.JPY).toFixed(4);
            document.getElementById('rate-USD').value = parseFloat(appSettings.rates.USD).toFixed(2);
            document.getElementById('rate-KRW').value = parseFloat(appSettings.rates.KRW).toFixed(4);
            document.getElementById('rate-EUR').value = parseFloat(appSettings.rates.EUR).toFixed(2);
            document.getElementById('rate-HKD').value = parseFloat(appSettings.rates.HKD).toFixed(2);
        }

        function updateRate(curr, val) {
            appSettings.rates[curr] = parseFloat(val);
            localStorage.setItem('travelFlow_settings_v8', JSON.stringify(appSettings));
            updateCostDisplay();
        }

        function convertToTWD(amount, currency) {
            if (!amount) return 0;
            const rate = appSettings.rates[currency] || 1;
            return Math.round(amount * rate);
        }

        // --- Weather Logic ---
        async function fetchCurrentLocationWeather() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                updateWeatherDisplay(lat, lon, 'current-weather-badge', 'current-temp', 'current-weather-icon');
            }, (err) => console.log('Loc Error', err));
        }

        async function fetchTripWeather(city) {
            if (!city) {
                document.getElementById('dest-weather-badge').classList.add('hidden');
                return;
            }
            try {
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`;
                const geoRes = await fetch(geoUrl);
                const geoData = await geoRes.json();
                if (geoData.results && geoData.results.length > 0) {
                    const { latitude, longitude } = geoData.results[0];
                    updateWeatherDisplay(latitude, longitude, 'dest-weather-badge', 'dest-temp', 'dest-weather-icon');
                }
            } catch (e) { console.error("Weather fetch failed", e); }
        }

        async function updateWeatherDisplay(lat, lon, badgeId, tempId, iconId) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    document.getElementById(tempId).innerText = `${temp}¬∞C`;
                    document.getElementById(badgeId).classList.remove('hidden');
                    const iconEl = document.getElementById(iconId);
                    if (code <= 3) iconEl.setAttribute('data-lucide', 'sun');
                    else if (code <= 48) iconEl.setAttribute('data-lucide', 'cloud');
                    else if (code <= 67) iconEl.setAttribute('data-lucide', 'cloud-rain');
                    else if (code <= 77) iconEl.setAttribute('data-lucide', 'snowflake');
                    else iconEl.setAttribute('data-lucide', 'cloud-lightning');
                    lucide.createIcons();
                }
            } catch(e) { console.log(e); }
        }

        // --- Core Helpers ---
        function applyTheme(themeName) {
            const theme = THEMES[themeName] || THEMES.teal;
            const root = document.documentElement;
            root.style.setProperty('--color-main', theme.main);
            root.style.setProperty('--color-light', theme.light);
            appSettings.theme = themeName;
            localStorage.setItem('travelFlow_settings_v8', JSON.stringify(appSettings));
        }
        function setTheme(name) { applyTheme(name); renderHome(); if(currentTripId) renderTimeline(); }
        function openSettings() { document.getElementById('modal-settings').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function saveData() { localStorage.setItem('travelFlow_trips_v8', JSON.stringify(trips)); }
        function getTrip(id) { return trips.find(t => t.id === id); }
        function getDayName(dateStr, addDays) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + addDays);
            const days = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            return days[date.getDay()];
        }
        function getFullDate(dateStr, addDays) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + addDays);
            return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
        }

        function calculateTotalCost(trip) {
            let totalTWD = 0;
            if (trip.days) {
                trip.days.forEach(day => {
                    day.items.forEach(item => { totalTWD += convertToTWD(parseInt(item.cost), item.currency || 'TWD'); });
                });
            }
            if (trip.shoppingList) {
                trip.shoppingList.forEach(item => {
                    if (item.checked && item.price) { totalTWD += convertToTWD(parseInt(item.price), item.currency || 'TWD'); }
                });
            }
            return totalTWD;
        }

        // --- Views ---
        function openTrip(id) {
            currentTripId = id;
            const trip = getTrip(id);
            const today = new Date(); today.setHours(0,0,0,0);
            const start = new Date(trip.startDate); start.setHours(0,0,0,0);
            const dayMs = 1000 * 60 * 60 * 24;
            const index = Math.round((today - start) / dayMs);
            if (index >= 0 && index < trip.days.length) { currentDayIndex = index; } else { currentDayIndex = 0; }

            switchTab('itinerary');
            document.getElementById('detail-title').innerText = trip.title;
            fetchTripWeather(trip.city);
            updateCostDisplay();
            document.getElementById('view-detail').classList.remove('translate-x-full');
            renderDays(); renderTimeline(); renderShopping(); startLiveTracking();
        }

        function goBack() {
            document.getElementById('view-detail').classList.add('translate-x-full');
            stopLiveTracking();
            setTimeout(() => { currentTripId = null; renderHome(); }, 300);
        }

        function switchTab(tab) {
            const itineraryContent = document.getElementById('content-itinerary');
            const shoppingContent = document.getElementById('content-shopping');
            const fab = document.getElementById('fab-container');
            const btnItinerary = document.getElementById('tab-itinerary');
            const btnShopping = document.getElementById('tab-shopping');
            
            if (tab === 'itinerary') {
                btnItinerary.className = "flex-1 py-1.5 text-xs font-medium rounded-md bg-white text-theme shadow-sm transition";
                btnShopping.className = "flex-1 py-1.5 text-xs font-medium rounded-md text-white/80 transition";
                itineraryContent.classList.remove('hidden'); shoppingContent.classList.add('hidden'); fab.classList.remove('hidden');
                startLiveTracking(); scrollToActiveItem();
            } else {
                btnShopping.className = "flex-1 py-1.5 text-xs font-medium rounded-md bg-white text-theme shadow-sm transition";
                btnItinerary.className = "flex-1 py-1.5 text-xs font-medium rounded-md text-white/80 transition";
                shoppingContent.classList.remove('hidden'); itineraryContent.classList.add('hidden'); fab.classList.add('hidden');
                stopLiveTracking();
            }
        }
        function updateCostDisplay() {
            const trip = getTrip(currentTripId);
            const total = calculateTotalCost(trip);
            document.getElementById('detail-cost').innerText = `Á∏ΩËä±Ë≤ª: NT$ ${total.toLocaleString()}`;
        }

        // --- Live Tracking ---
        function startLiveTracking() {
            if (liveTrackerInterval) clearInterval(liveTrackerInterval);
            updateLiveStatus();
            liveTrackerInterval = setInterval(updateLiveStatus, 60000);
        }
        function stopLiveTracking() {
            if (liveTrackerInterval) clearInterval(liveTrackerInterval);
            document.querySelectorAll('.active-item-card').forEach(el => el.classList.remove('active-item-card'));
        }
        function updateLiveStatus() {
            const trip = getTrip(currentTripId); if (!trip) return;
            const today = new Date();
            const start = new Date(trip.startDate); start.setHours(0,0,0,0);
            const viewDate = new Date(start); viewDate.setDate(viewDate.getDate() + currentDayIndex);
            
            if (viewDate.toDateString() !== today.toDateString()) {
                document.querySelectorAll('.active-item-card').forEach(el => el.classList.remove('active-item-card')); return;
            }
            const nowTime = today.getHours() * 60 + today.getMinutes();
            const items = trip.days[currentDayIndex].items;
            let activeItemId = null;
            const sortedItems = items.map(i => {
                const [h, m] = i.time.split(':').map(Number);
                return { ...i, mins: h * 60 + m };
            }).sort((a, b) => a.mins - b.mins);
            for (let i = 0; i < sortedItems.length; i++) {
                if (sortedItems[i].mins <= nowTime) activeItemId = sortedItems[i].id; else break;
            }
            if (!activeItemId && sortedItems.length > 0) {
                 if (sortedItems[0].mins - nowTime <= 60 && sortedItems[0].mins > nowTime) activeItemId = sortedItems[0].id;
            }
            document.querySelectorAll('.active-item-card').forEach(el => el.classList.remove('active-item-card'));
            if (activeItemId) {
                const el = document.getElementById(`card-${activeItemId}`);
                if (el) el.classList.add('active-item-card');
            }
        }
        function scrollToActiveItem() {
            setTimeout(() => {
                const active = document.querySelector('.active-item-card');
                if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        // --- Home ---
        function renderHome() {
            const container = document.getElementById('trip-list-container');
            container.innerHTML = '';
            if (trips.length === 0) { container.innerHTML = `<div class="text-center mt-20 opacity-40"><p>Â∞öÊú™Âª∫Á´ãÊóÖË°å</p></div>`; return; }
            trips.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(trip => {
                const el = document.createElement('div');
                el.className = 'swipe-item-container rounded-2xl shadow-sm overflow-hidden bg-white';
                const dayCount = trip.days.length;
                const totalCost = calculateTotalCost(trip);
                el.innerHTML = `
                    <div class="swipe-action-bg"><span class="text-white font-bold flex items-center gap-1"><i data-lucide="trash-2" class="w-5 h-5"></i> Âà™Èô§</span></div>
                    <div class="swipe-content bg-white p-4 border border-gray-100 flex justify-between items-center relative"
                         onclick="openTrip('${trip.id}')" ontouchstart="handleTouchStart(event, this, '${trip.id}', 'trip')" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this, '${trip.id}', 'trip')">
                        <div class="overflow-hidden">
                            <h3 class="font-bold text-lg text-gray-800 truncate pr-4">${trip.title}</h3>
                            <div class="text-xs text-gray-500 mt-1 flex gap-3">
                                <span><i data-lucide="calendar" class="w-3 h-3 inline"></i> ${dayCount} Â§©</span>
                                <span>NT$ ${totalCost.toLocaleString()}</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5 flex-shrink-0"></i>
                    </div>`;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- Timeline ---
        function renderTimeline() {
            const trip = getTrip(currentTripId);
            const container = document.getElementById('timeline-container');
            const emptyState = document.getElementById('timeline-empty');
            container.innerHTML = '<div class="timeline-line"></div>';
            const items = trip.days[currentDayIndex].items;
            if (items.length === 0) { emptyState.classList.remove('hidden'); container.classList.add('hidden'); return; }
            emptyState.classList.add('hidden'); container.classList.remove('hidden');
            items.sort((a, b) => a.time.localeCompare(b.time));
            items.forEach((item) => {
                const el = document.createElement('div');
                el.className = 'swipe-item-container relative mb-6 pl-9';
                let iconName = 'map-pin'; let colorClass = 'bg-blue-500';
                if (item.type === 'food') { iconName = 'utensils'; colorClass = 'bg-orange-500'; }
                if (item.type === 'transport') { iconName = 'bus'; colorClass = 'bg-indigo-500'; }
                if (item.type === 'stay') { iconName = 'bed'; colorClass = 'bg-purple-500'; }
                if (item.type === 'flight') { iconName = 'plane'; colorClass = 'bg-sky-500'; }
                const mapLink = item.location ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}` : '#';
                const backupMapLink = item.backupLocation ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.backupLocation)}` : '#';
                const curr = item.currency || 'TWD';
                const costDisplay = item.cost ? `${curr} ${item.cost}` : '';
                el.innerHTML = `
                    <div class="absolute left-0 top-1 w-8 h-8 flex items-center justify-center z-10 bg-gray-50">
                        <div class="w-7 h-7 rounded-full ${colorClass} text-white flex items-center justify-center shadow-md border-2 border-white"><i data-lucide="${iconName}" class="w-3.5 h-3.5"></i></div>
                    </div>
                    <div class="relative">
                         <div class="swipe-action-bg rounded-xl"><span class="text-white font-bold flex items-center gap-1"><i data-lucide="trash-2" class="w-5 h-5"></i> Âà™Èô§</span></div>
                         <div id="card-${item.id}" class="swipe-content bg-white p-3.5 rounded-xl shadow-sm border border-gray-100 flex flex-wrap gap-4 transition-all duration-500"
                             onclick="openEditItemModal('${item.id}')" ontouchstart="handleTouchStart(event, this, '${item.id}', 'item')" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this, '${item.id}', 'item')">
                            <div class="flex-1 min-w-[150px]">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-[10px] font-bold text-theme bg-theme-light px-1.5 py-0.5 rounded inline-block">${item.time}</span>
                                    ${costDisplay ? `<span class="text-xs font-bold text-gray-500">${costDisplay}</span>` : ''}
                                </div>
                                <h4 class="font-bold text-gray-800 text-base leading-tight mb-1 break-words">${item.title}</h4>
                                ${item.location ? `<a href="${mapLink}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center text-xs text-gray-500 hover:text-theme gap-1 bg-gray-50 px-2 py-1 rounded transition max-w-full truncate"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i> <span class="truncate">${item.location}</span></a>` : ''}
                                ${item.note ? `<p class="mt-2 text-xs text-gray-500 line-clamp-2">${item.note}</p>` : ''}
                            </div>
                            ${item.hasBackup ? `<div class="w-full h-px bg-gray-100 sm:w-px sm:h-auto sm:bg-gray-200"></div><div class="flex-1 sm:max-w-[140px] min-w-[120px] bg-gray-50 rounded-lg p-2 border border-dashed border-gray-300 self-stretch flex flex-col justify-center"><span class="text-[9px] text-gray-400 font-bold uppercase mb-0.5">Plan B</span><h5 class="font-bold text-gray-600 text-sm leading-tight mb-1 break-words">${item.backupTitle}</h5>${item.backupLocation ? `<a href="${backupMapLink}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] text-gray-500 flex items-center gap-1 underline decoration-gray-300"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i> Âú∞Âúñ</a>` : ''}</div>` : ''}
                         </div>
                    </div>`;
                container.appendChild(el);
            });
            lucide.createIcons(); updateLiveStatus();
        }

        // --- Swipe Logic ---
        let touchStartX = 0; let touchCurrentX = 0; let isSwiping = false;
        function handleTouchStart(e, el) { touchStartX = e.touches[0].clientX; el.style.transition = 'none'; }
        function handleTouchMove(e, el) {
            touchCurrentX = e.touches[0].clientX;
            const diff = touchCurrentX - touchStartX;
            if (diff > 0 && diff < el.clientWidth * 0.4) { e.preventDefault(); isSwiping = true; el.style.transform = `translateX(${diff}px)`; }
        }
        function handleTouchEnd(e, el, id, type) {
            el.style.transition = 'transform 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
            const diff = touchCurrentX - touchStartX;
            if (isSwiping && diff > 100) {
                el.style.transform = `translateX(100%)`;
                setTimeout(() => {
                    if (type === 'trip') deleteTrip(id);
                    if (type === 'item') deleteItem(id);
                    if (type === 'shop') deleteShopItem(id);
                }, 200);
            } else { el.style.transform = `translateX(0)`; }
            isSwiping = false; touchStartX = 0; touchCurrentX = 0;
        }

        // --- Shopping ---
        function renderShopping() {
            const trip = getTrip(currentTripId);
            const container = document.getElementById('shopping-list');
            const emptyState = document.getElementById('shopping-empty');
            container.innerHTML = '';
            if (!trip.shoppingList || trip.shoppingList.length === 0) { emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');
            trip.shoppingList.forEach(item => {
                const el = document.createElement('div');
                el.className = 'swipe-item-container rounded-xl overflow-hidden';
                const priceInputHtml = item.checked ? `
                    <div class="flex items-center border-l border-gray-100 pl-2 ml-2 gap-1 flex-shrink-0">
                        <select onchange="updateShopCurrency('${item.id}', this.value)" class="text-[10px] bg-gray-100 rounded p-1 font-bold text-gray-500 outline-none h-8">
                            <option value="TWD" ${item.currency === 'TWD' ? 'selected' : ''}>TWD</option>
                            <option value="JPY" ${item.currency === 'JPY' ? 'selected' : ''}>JPY</option>
                            <option value="USD" ${item.currency === 'USD' ? 'selected' : ''}>USD</option>
                            <option value="KRW" ${item.currency === 'KRW' ? 'selected' : ''}>KRW</option>
                            <option value="EUR" ${item.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                            <option value="HKD" ${item.currency === 'HKD' ? 'selected' : ''}>HKD</option>
                        </select>
                        <input type="number" value="${item.price || ''}" onchange="updateShopPrice('${item.id}', this.value)" placeholder="0" class="w-20 p-1 text-sm bg-gray-50 rounded border-none focus:ring-1 focus:ring-teal-500 outline-none text-right font-bold text-theme h-8">
                    </div>` : '';
                el.innerHTML = `
                    <div class="swipe-action-bg"><i data-lucide="trash-2" class="w-5 h-5 text-white"></i></div>
                    <div class="swipe-content bg-white p-3 border border-gray-100 flex items-center justify-between"
                         ontouchstart="handleTouchStart(event, this, '${item.id}', 'shop')" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this, '${item.id}', 'shop')">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <button onclick="toggleShopItem('${item.id}')" class="text-theme flex-shrink-0">${item.checked ? '<i data-lucide="check-square" class="w-6 h-6"></i>' : '<i data-lucide="square" class="w-6 h-6 text-gray-300"></i>'}</button>
                            <span class="font-medium ${item.checked ? 'text-gray-400 line-through' : 'text-gray-800'} truncate">${item.text}</span>
                        </div>
                        ${priceInputHtml}
                    </div>`;
                container.appendChild(el);
            });
            lucide.createIcons();
        }
        function addShopItem() {
            const input = document.getElementById('new-shop-item');
            if (!input.value.trim()) return;
            const trip = getTrip(currentTripId);
            if (!trip.shoppingList) trip.shoppingList = [];
            trip.shoppingList.push({ id: generateId(), text: input.value.trim(), checked: false, price: 0, currency: 'TWD' });
            input.value = ''; saveData(); renderShopping(); updateCostDisplay();
        }
        function toggleShopItem(id) { const trip = getTrip(currentTripId); const item = trip.shoppingList.find(i => i.id === id); if(item) { item.checked = !item.checked; saveData(); renderShopping(); updateCostDisplay(); }}
        function updateShopPrice(id, price) { const trip = getTrip(currentTripId); const item = trip.shoppingList.find(i => i.id === id); if(item) { item.price = price; saveData(); updateCostDisplay(); }}
        function updateShopCurrency(id, curr) { const trip = getTrip(currentTripId); const item = trip.shoppingList.find(i => i.id === id); if(item) { item.currency = curr; saveData(); updateCostDisplay(); }}
        function deleteShopItem(id) { const trip = getTrip(currentTripId); trip.shoppingList = trip.shoppingList.filter(i => i.id !== id); saveData(); renderShopping(); updateCostDisplay(); }

        // --- Modals & CRUD ---
        function openAddTripModal() { document.getElementById('modal-trip').classList.remove('hidden'); tempDaysCount = 3; document.getElementById('display-days-count').innerText = tempDaysCount + ' Â§©'; document.getElementById('input-trip-name').value = ''; document.getElementById('input-trip-city').value = ''; }
        function adjustDays(d) { tempDaysCount += d; if(tempDaysCount < 1) tempDaysCount = 1; document.getElementById('display-days-count').innerText = tempDaysCount + ' Â§©'; }
        function saveNewTrip() {
            const title = document.getElementById('input-trip-name').value.trim();
            const city = document.getElementById('input-trip-city').value.trim();
            const date = document.getElementById('input-trip-date').value;
            if (!title || !date) return alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥Ë≥áË®ä');
            const newTrip = { id: generateId(), title, city, startDate: date, createdAt: new Date().toISOString(), shoppingList: [], days: [] };
            for(let i=0; i<tempDaysCount; i++) newTrip.days.push({ items: [] });
            trips.push(newTrip); saveData(); renderHome(); closeModal('modal-trip');
        }
        function deleteTrip(id) { trips = trips.filter(t => t.id !== id); saveData(); renderHome(); }
        function togglePlanBInputs() { const checked = document.getElementById('has-plan-b').checked; const container = document.getElementById('plan-b-inputs'); if (checked) container.classList.remove('hidden'); else container.classList.add('hidden'); }
        function openAddItemModal() { editingItemId = null; document.getElementById('modal-item').classList.remove('hidden'); document.getElementById('item-time').value = '09:00'; document.getElementById('item-title').value = ''; document.getElementById('item-location').value = ''; document.getElementById('item-cost').value = ''; document.getElementById('item-currency').value = 'TWD'; document.getElementById('item-note').value = ''; document.getElementById('has-plan-b').checked = false; togglePlanBInputs(); document.getElementById('backup-title').value = ''; document.getElementById('backup-location').value = ''; }
        function openEditItemModal(itemId) {
            editingItemId = itemId; const trip = getTrip(currentTripId); const item = trip.days[currentDayIndex].items.find(i => i.id === itemId); if (!item) return;
            document.getElementById('modal-item').classList.remove('hidden'); document.getElementById('item-time').value = item.time; document.getElementById('item-title').value = item.title; document.getElementById('item-location').value = item.location || ''; document.getElementById('item-cost').value = item.cost || ''; document.getElementById('item-currency').value = item.currency || 'TWD'; document.getElementById('item-note').value = item.note || ''; document.getElementById('item-type').value = item.type; document.getElementById('has-plan-b').checked = item.hasBackup || false; togglePlanBInputs(); document.getElementById('backup-title').value = item.backupTitle || ''; document.getElementById('backup-location').value = item.backupLocation || '';
        }
        function saveItem() {
            const time = document.getElementById('item-time').value; const title = document.getElementById('item-title').value.trim(); const type = document.getElementById('item-type').value; const location = document.getElementById('item-location').value.trim(); const cost = document.getElementById('item-cost').value; const currency = document.getElementById('item-currency').value; const note = document.getElementById('item-note').value.trim(); const hasBackup = document.getElementById('has-plan-b').checked; const backupTitle = document.getElementById('backup-title').value.trim(); const backupLocation = document.getElementById('backup-location').value.trim();
            if (!title) return alert('Ë´ãËº∏ÂÖ•Ê®ôÈ°å'); const trip = getTrip(currentTripId); const newItem = { id: editingItemId || generateId(), time, title, type, location, cost, currency, note, hasBackup, backupTitle, backupLocation };
            if (editingItemId) { const idx = trip.days[currentDayIndex].items.findIndex(i => i.id === editingItemId); if (idx > -1) trip.days[currentDayIndex].items[idx] = newItem; } else { trip.days[currentDayIndex].items.push(newItem); }
            saveData(); closeModal('modal-item'); renderTimeline(); updateCostDisplay();
        }
        function deleteItem(itemId) { const trip = getTrip(currentTripId); trip.days[currentDayIndex].items = trip.days[currentDayIndex].items.filter(i => i.id !== itemId); saveData(); renderTimeline(); updateCostDisplay(); }
        function renderDays() {
            const trip = getTrip(currentTripId); const container = document.getElementById('day-selector'); container.innerHTML = '';
            trip.days.forEach((day, index) => {
                const btn = document.createElement('button'); const isActive = index === currentDayIndex; btn.className = `flex-none flex flex-col items-center justify-center w-12 h-14 rounded-xl transition-all ${isActive ? 'bg-theme text-white shadow-md' : 'bg-gray-100 text-gray-500'}`; btn.innerHTML = `<span class="text-xs font-bold">D${index + 1}</span><span class="text-[10px]">${getDayName(trip.startDate, index)}</span>`; btn.onclick = () => { currentDayIndex = index; renderDays(); renderTimeline(); startLiveTracking(); }; container.appendChild(btn);
            });
            const addBtn = document.createElement('button'); addBtn.className = "flex-none flex flex-col items-center justify-center w-10 h-14 rounded-xl bg-gray-50 text-gray-300"; addBtn.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i>`; addBtn.onclick = () => { trip.days.push({ items: [] }); saveData(); renderDays(); }; container.appendChild(addBtn);
        }

        // --- FULL PDF EXPORT Logic (New in v8.0) ---
        function exportFullPDF() {
            const trip = getTrip(currentTripId);
            const container = document.getElementById('pdf-export-container');
            container.innerHTML = ''; // Clear

            // 1. Cover Page
            const totalCost = calculateTotalCost(trip);
            let html = `
                <div style="text-align:center; margin-top:100px; margin-bottom: 50px;">
                    <h1 style="font-size: 32px; color: #0d9488;">${trip.title}</h1>
                    <p style="color: gray; font-size: 14px;">TravelFlow ÊóÖÈÅäÊâãÂÜä</p>
                    <div style="margin-top: 50px; padding: 20px; border: 1px solid #ddd; display: inline-block; border-radius: 10px;">
                        <p><strong>Âá∫ÁôºÊó•ÊúüÔºö</strong> ${getFullDate(trip.startDate, 0)}</p>
                        <p><strong>Á∏ΩÂ§©Êï∏Ôºö</strong> ${trip.days.length} Â§©</p>
                        <p><strong>Á∏ΩÈ†êÁÆó‰º∞Ë®àÔºö</strong> NT$ ${totalCost.toLocaleString()}</p>
                    </div>
                </div>
                <div class="pdf-page-break"></div>
            `;

            // 2. Iterate Days
            trip.days.forEach((day, index) => {
                const dateStr = getFullDate(trip.startDate, index);
                const dayName = getDayName(trip.startDate, index);
                html += `<div class="pdf-day-header">Day ${index + 1} - ${dateStr} (${dayName})</div>`;
                
                // Sort items
                const dayItems = [...day.items].sort((a, b) => a.time.localeCompare(b.time));
                
                if (dayItems.length === 0) {
                    html += `<p style="color: #999; font-style: italic; padding: 10px;">Êú¨Êó•ÁÑ°Ë°åÁ®ã</p>`;
                } else {
                    dayItems.forEach(item => {
                        html += `
                        <div class="pdf-item">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${item.time} - ${item.title}</strong>
                                <span>${item.cost ? item.currency + ' ' + item.cost : ''}</span>
                            </div>
                            ${item.location ? `<div style="font-size: 12px; color: #555;">üìç ${item.location}</div>` : ''}
                            ${item.note ? `<div style="font-size: 12px; color: #666; margin-top:4px;">üìù ${item.note}</div>` : ''}
                            
                            ${item.hasBackup ? `
                                <div style="margin-top: 8px; font-size: 12px; color: #888; border-left: 2px dashed #ccc; padding-left: 8px;">
                                    <strong>ÂÇôÊ°à Plan BÔºö</strong> ${item.backupTitle}
                                    ${item.backupLocation ? ` (${item.backupLocation})` : ''}
                                </div>
                            ` : ''}
                        </div>`;
                    });
                }
            });

            // 3. Shopping List Page
            html += `<div class="pdf-page-break"></div>`;
            html += `<div class="pdf-day-header">Ë®òÂ∏≥ & Ë≥ºÁâ©Ê∏ÖÂñÆ</div>`;
            if (trip.shoppingList && trip.shoppingList.length > 0) {
                trip.shoppingList.forEach(item => {
                     html += `
                        <div style="border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between;">
                            <span>${item.checked ? '‚òë' : '‚òê'} ${item.text}</span>
                            <span>${item.checked && item.price ? (item.currency || 'TWD') + ' ' + item.price : ''}</span>
                        </div>
                     `;
                });
            } else {
                html += `<p>ÁÑ°Ë≥ºÁâ©Á¥ÄÈåÑ</p>`;
            }

            container.innerHTML = html;

            // Generate
            const btn = document.querySelector('button[onclick="exportFullPDF()"]');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i>`;
            lucide.createIcons();

            const opt = {
                margin: 10,
                filename: `${trip.title}_ÂÆåÊï¥Ë°åÁ®ã.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(container).save().then(() => {
                btn.innerHTML = originalIcon;
                lucide.createIcons();
                alert('ÂÆåÊï¥Ë°åÁ®ã PDF Â∑≤‰∏ãËºâÔºÅ');
            });
        }
    </script>
</body>
</html>

