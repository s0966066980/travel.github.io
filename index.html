<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelFlow</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#F4F4F0',
                            card: '#FFFFFF',
                            text: '#444444',
                            border: '#D3D3D3',
                            accent: '#7F0019',
                            primary: '#505050',
                            secondary: '#8E8E8E'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        serif: ['"Noto Serif TC"', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root { --safe-bottom: env(safe-area-inset-bottom, 20px); }
        body { background-color: #F4F4F0; color: #444444; overscroll-behavior-y: none; -webkit-user-select: none; user-select: none; position: fixed; width: 100%; height: 100%; overflow: hidden; }
        
        /* Layout */
        .app-layout { display: flex; height: 100%; width: 100%; overflow: hidden; }
        .sidebar { width: 68px; background: #EFEFEA; border-right: 1px solid #E0E0E0; display: flex; flex-direction: column; align-items: center; padding-top: 1.5rem; z-index: 20; flex-shrink: 0; }
        .nav-btn { width: 44px; height: 44px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; margin-bottom: 1.2rem; transition: all 0.3s ease; border: 1px solid transparent; }
        .nav-btn.active { background-color: #FFFFFF; color: #333; border: 1px solid #D0D0D0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-btn i { width: 20px; height: 20px; }
        .nav-btn span { font-size: 9px; margin-top: 2px; font-weight: 500; }
        
        .main-content { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; background: #F4F4F0; }
        
        /* Marquee */
        .marquee-container { background-color: #EAEAEA; color: #7F0019; overflow: hidden; white-space: nowrap; padding: 8px 0; border-bottom: 1px solid #D0D0D0; flex-shrink: 0; height: 36px; display: flex; align-items: center; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; font-size: 12px; font-family: 'Noto Serif TC'; }
        .marquee-safe { background-color: #E6EAE6; color: #4A6E4A; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 12px; border-bottom: 1px solid #C0C0C0; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 1.2rem; padding-bottom: 100px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Cards */
        .muji-card { background: #FFFFFF; border: 1px solid #E0E0E0; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        
        /* Timeline */
        .timeline-line { position: absolute; left: 19px; top: 20px; bottom: 0; width: 1px; background: none; border-left: 1px dashed #C0C0C0; z-index: 0; }
        .item-past { opacity: 0.5; filter: grayscale(1); }
        .item-active { border-left: 4px solid #7F7F7F !important; background: #FAFAFA !important; }
        
        /* Gallery */
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .gallery-item { aspect-ratio: 1; border-radius: 4px; overflow: hidden; position: relative; border: 1px solid #E0E0E0; }
        .gallery-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); padding: 8px; color: #333; border-top: 1px solid #E0E0E0; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(244,244,240,0.8); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { width: 90%; max-width: 400px; background: #FFFFFF; border-radius: 8px; border: 1px solid #C0C0C0; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; flex-direction: column; max-height: 85vh; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        .muji-input { width: 100%; padding: 10px; background: #F8F8F8; border: 1px solid #E0E0E0; border-radius: 4px; outline: none; font-size: 14px; transition: border-color 0.2s; }
        .muji-input:focus { border-color: #888; background: #FFF; }
        
        /* Type Selector */
        .type-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px; color: #64748b; transition: all 0.2s; }
        .type-btn.selected { background-color: #EFEFEA; border-color: #505050; color: #333; }
        .type-btn i { width: 20px; height: 20px; margin-bottom: 4px; }

        #export-container { position: fixed; top: -9999px; left: 0; width: 600px; background: #F4F4F0; z-index: -5; font-family: 'Noto Sans TC'; }
        
        /* Helper for layout */
        .item-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
        .delete-btn { padding: 8px; color: #ccc; border-radius: 4px; flex-shrink: 0; }
        .delete-btn:hover { color: #7F0019; background-color: #fcebeb; }
    </style>
</head>
<body>

    <div id="app">
        <!-- VIEW: HOME -->
        <div id="view-home" class="w-full h-full flex flex-col absolute inset-0 z-20 transition-transform duration-300 bg-muji-bg">
            <header class="p-6 pb-2 flex justify-between items-center shrink-0 border-b border-muji-border bg-muji-bg">
                <div>
                    <h1 class="text-2xl font-serif font-bold text-muji-text tracking-widest">TravelFlow</h1>
                    <p class="text-xs text-muji-secondary tracking-widest mt-1">SIMPLICITY 6.6</p>
                </div>
                <button onclick="openSettings()" class="p-2 text-muji-secondary hover:text-muji-text transition"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i></button>
            </header>
            
            <div id="trip-list" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
            
            <div class="p-5 shrink-0 pb-safe">
                <button onclick="openAddTripModal()" class="w-full bg-muji-primary text-white py-4 rounded shadow-sm hover:bg-gray-700 transition flex items-center justify-center gap-2 text-sm tracking-widest"><i data-lucide="plus" class="w-4 h-4"></i> Êñ∞Â¢ûÊóÖË°å</button>
            </div>
        </div>

        <!-- VIEW: DETAIL -->
        <div id="view-detail" class="w-full h-full bg-muji-bg absolute inset-0 z-30 translate-x-full transition-transform duration-300 flex flex-col">
            <div class="bg-muji-bg border-b border-muji-border p-4 shrink-0 z-30">
                <div class="flex items-center justify-between mb-3">
                    <button onclick="goBack()" class="p-1 text-muji-secondary hover:text-muji-text"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                    <div class="text-center">
                        <h2 id="detail-title" class="font-serif font-bold text-lg text-muji-text tracking-wide">Trip Title</h2>
                        <span id="detail-cost" class="text-[10px] text-muji-secondary block mt-0.5 tracking-wider">TOTAL: NT$ 0</span>
                    </div>
                    <button onclick="openAddTripModal(true)" class="p-1 text-muji-secondary hover:text-muji-text"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                </div>
                <div class="flex justify-between items-center bg-white border border-muji-border rounded px-3 py-2 text-xs text-muji-secondary mb-1">
                    <div class="flex items-center gap-1"><span class="font-bold text-muji-text">üáπüáº TW</span><span id="clock-tw" class="font-mono">00:00:00</span></div>
                    <div class="h-3 w-px bg-muji-border"></div>
                    <div class="flex items-center gap-1"><span class="font-bold text-muji-text">üìç LOC</span><span id="clock-loc" class="font-mono">00:00:00</span></div>
                </div>
            </div>

            <div id="marquee-wrapper" class="marquee-container hidden"><div id="marquee-content" class="marquee-text"></div></div>
            <div id="marquee-safe" class="marquee-safe hidden"><span class="tracking-widest">CHECKLIST COMPLETED</span></div>

            <div class="app-layout">
                <div class="sidebar">
                    <button onclick="switchTab('itinerary')" id="nav-itinerary" class="nav-btn active"><i data-lucide="map"></i><span>Ë°åÁ®ã</span></button>
                    <button onclick="switchTab('shopping')" id="nav-shopping" class="nav-btn"><i data-lucide="shopping-bag"></i><span>Ë≥ºÁâ©</span></button>
                    <button onclick="switchTab('packing')" id="nav-packing" class="nav-btn"><i data-lucide="check-square"></i><span>Ë°åÊùé</span></button>
                    <div class="mt-auto mb-20">
                        <button onclick="exportAll()" class="nav-btn" style="border-top: 1px solid #E0E0E0; border-radius: 0;"><i data-lucide="download"></i><span>ÂåØÂá∫</span></button>
                    </div>
                </div>
                <div class="main-content">
                    <div id="tab-itinerary" class="flex flex-col h-full w-full">
                        <div class="p-3 bg-muji-bg border-b border-muji-border shrink-0 flex items-center gap-2">
                            <div class="flex-1 flex gap-2 overflow-x-auto no-scrollbar" id="day-selector"></div>
                            <button onclick="modDays(1)" class="w-8 h-8 bg-white border border-muji-border text-muji-secondary flex items-center justify-center shrink-0 rounded hover:bg-gray-50"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            <button onclick="deleteCurrentDay()" class="w-8 h-8 bg-white border border-muji-border text-muji-accent flex items-center justify-center shrink-0 rounded hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <div id="itinerary-list" class="scroll-area"></div>
                    </div>
                    <div id="tab-shopping" class="flex flex-col h-full hidden w-full">
                        <div class="p-3 bg-muji-bg border-b border-muji-border flex justify-between items-center shrink-0">
                            <span class="text-xs text-muji-secondary tracking-widest">SHOPPING LIST</span>
                            <div class="flex border border-muji-border bg-white rounded-sm">
                                <button onclick="setGalleryMode(false)" class="p-1.5 text-muji-secondary hover:text-muji-text"><i data-lucide="list" class="w-4 h-4"></i></button>
                                <div class="w-px bg-muji-border"></div>
                                <button onclick="setGalleryMode(true)" class="p-1.5 text-muji-secondary hover:text-muji-text"><i data-lucide="grid" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div id="shopping-list" class="scroll-area"></div>
                    </div>
                    <div id="tab-packing" class="flex flex-col h-full hidden w-full">
                        <div class="p-3 bg-white border-b border-muji-border text-muji-secondary text-xs text-center tracking-widest">ITEMS TO PACK</div>
                        <div id="packing-list" class="scroll-area"></div>
                    </div>
                </div>
            </div>
            <div class="absolute bottom-8 right-6 z-40 pb-safe">
                <button onclick="handleFab()" class="w-14 h-14 bg-muji-primary text-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-700 transition active:scale-95"><i data-lucide="plus" class="w-6 h-6"></i></button>
            </div>
        </div>
    </div>

    <div id="export-container"></div>

    <!-- MODALS -->
    
    <!-- Trip Modal -->
    <div id="modal-trip" class="modal-overlay hidden">
        <div class="modal-box p-6 relative">
            <button onclick="closeModal('modal-trip')" class="absolute top-4 right-4 text-muji-secondary"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-lg font-bold mb-6 text-center tracking-widest text-muji-text" id="trip-modal-title">TRAVEL PLAN</h3>
            <input type="hidden" id="trip-id">
            <div class="space-y-4 overflow-y-auto">
                <div><label class="text-xs text-muji-secondary block mb-1">ÂêçÁ®± NAME</label><input type="text" id="trip-name" class="muji-input"></div>
                <div><label class="text-xs text-muji-secondary block mb-1">Âú∞Èªû LOCATION</label><input type="text" id="trip-loc" class="muji-input" placeholder="e.g. Tokyo"></div>
                <div><label class="text-xs text-muji-secondary block mb-1">Êó•Êúü DATE</label><input type="date" id="trip-date" class="muji-input"></div>
                <div class="flex items-center justify-between border-t border-muji-border pt-4">
                    <span class="text-xs text-muji-secondary">Â§©Êï∏ DAYS</span>
                    <div class="flex items-center gap-4">
                        <button onclick="changeTripDays(-1)" class="w-8 h-8 border border-muji-border bg-white rounded text-muji-text">-</button>
                        <span id="trip-days" class="font-serif font-bold text-lg w-6 text-center">3</span>
                        <button onclick="changeTripDays(1)" class="w-8 h-8 border border-muji-border bg-white rounded text-muji-text">+</button>
                    </div>
                </div>
            </div>
            <div class="mt-6"><button onclick="saveTrip()" class="w-full py-3 bg-muji-primary text-white text-sm tracking-widest rounded hover:bg-gray-700 transition">SAVE</button></div>
        </div>
    </div>

    <!-- Itinerary Item Modal -->
    <div id="modal-item" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="p-4 border-b border-muji-border flex justify-between items-center"><h3 class="font-bold text-muji-text tracking-wide">EVENT DETAILS</h3><button onclick="closeModal('modal-item')" class="text-muji-secondary"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="flex-1 overflow-y-auto p-5 space-y-4">
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-6 gap-2 mb-2">
                    <button onclick="selectType('flight')" id="type-flight" class="type-btn p-2 border border-muji-border rounded text-muji-secondary hover:bg-gray-100 flex justify-center"><i data-lucide="plane" class="w-4 h-4"></i></button>
                    <button onclick="selectType('transport')" id="type-transport" class="type-btn p-2 border border-muji-border rounded text-muji-secondary hover:bg-gray-100 flex justify-center"><i data-lucide="bus" class="w-4 h-4"></i></button>
                    <button onclick="selectType('food')" id="type-food" class="type-btn p-2 border border-muji-border rounded text-muji-secondary hover:bg-gray-100 flex justify-center"><i data-lucide="utensils" class="w-4 h-4"></i></button>
                    <button onclick="selectType('activity')" id="type-activity" class="type-btn p-2 border border-muji-border rounded text-muji-secondary hover:bg-gray-100 flex justify-center"><i data-lucide="ticket" class="w-4 h-4"></i></button>
                    <button onclick="selectType('shopping')" id="type-shopping" class="type-btn p-2 border border-muji-border rounded text-muji-secondary hover:bg-gray-100 flex justify-center"><i data-lucide="shopping-bag" class="w-4 h-4"></i></button>
                    <button onclick="selectType('stay')" id="type-stay" class="type-btn p-2 border border-muji-border rounded text-muji-secondary hover:bg-gray-100 flex justify-center"><i data-lucide="bed" class="w-4 h-4"></i></button>
                </div>
                <input type="hidden" id="item-type" value="activity">
                <div class="flex gap-3">
                    <div class="w-1/2"><label class="text-[10px] text-muji-secondary block mb-1">DAY</label><select id="item-day" class="muji-input"></select></div>
                    <div class="w-1/2"><label class="text-[10px] text-muji-secondary block mb-1">TIME</label><input type="time" id="item-time" class="muji-input"></div>
                </div>
                <input type="text" id="item-title" placeholder="Title" class="muji-input font-bold text-lg">
                <div class="p-3 border border-muji-border rounded bg-gray-50">
                    <label class="text-[10px] text-muji-secondary block mb-1">COST</label>
                    <div class="flex gap-2">
                        <select id="item-currency" class="muji-input w-24" onchange="calcItemTWD()"><option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option><option value="KRW">KRW</option><option value="EUR">EUR</option><option value="HKD">HKD</option></select>
                        <input type="number" id="item-cost" placeholder="0" class="muji-input flex-1" onkeyup="calcItemTWD()">
                    </div>
                    <div class="text-right text-xs text-muji-text mt-1">‚âà NT$ <span id="item-twd-display">0</span></div>
                </div>
                <div class="flex items-center gap-2 mb-2"><i data-lucide="map-pin" class="w-4 h-4 text-muji-secondary"></i><input type="text" id="item-loc" placeholder="Location" class="muji-input border-0 border-b border-muji-border rounded-none bg-transparent px-0"></div>
                <textarea id="item-note" rows="2" placeholder="Notes..." class="muji-input"></textarea>
            </div>
            <div class="p-4 border-t border-muji-border"><button onclick="saveItem()" class="w-full py-3 bg-muji-primary text-white text-sm tracking-widest rounded hover:bg-gray-700 transition">CONFIRM</button></div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="modal-shop" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="p-4 border-b border-muji-border flex justify-between items-center"><h3 class="font-bold text-muji-text tracking-wide">ADD PURCHASE</h3><button onclick="closeModal('modal-shop')" class="text-muji-secondary"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="flex-1 overflow-y-auto p-5 space-y-4">
                <input type="hidden" id="shop-id">
                <input type="text" id="shop-name" placeholder="Item Name" class="muji-input font-bold">
                <div class="p-3 border border-muji-border rounded bg-gray-50">
                    <div class="flex gap-2">
                        <select id="shop-curr" class="muji-input w-24" onchange="calcShopTWD()"><option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option><option value="KRW">KRW</option><option value="EUR">EUR</option><option value="HKD">HKD</option></select>
                        <input type="number" id="shop-price" placeholder="Price" class="muji-input flex-1" onkeyup="calcShopTWD()">
                    </div>
                    <div class="text-right text-xs text-muji-text mt-1">‚âà NT$ <span id="shop-twd-display">0</span></div>
                </div>
                <input type="text" id="shop-loc" placeholder="Location" class="muji-input">
                <div class="relative h-32 bg-gray-50 rounded border border-dashed border-muji-border flex items-center justify-center overflow-hidden">
                    <input type="file" id="shop-img-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImage(this)">
                    <img id="shop-img-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div id="shop-img-placeholder" class="text-center text-muji-secondary"><i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i><span class="text-xs">Photo</span></div>
                </div>
            </div>
            <div class="p-4 border-t border-muji-border"><button onclick="saveShop()" class="w-full py-3 bg-muji-primary text-white text-sm tracking-widest rounded hover:bg-gray-700 transition">ADD</button></div>
        </div>
    </div>

    <!-- Packing Modal -->
    <div id="modal-pack" class="modal-overlay hidden">
        <div class="modal-box p-6 relative">
            <button onclick="closeModal('modal-pack')" class="absolute top-4 right-4 text-muji-secondary"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="font-bold text-lg mb-4 text-muji-text tracking-wide">ADD ITEM</h3>
            <input type="text" id="pack-name" placeholder="Item Name" class="muji-input mb-4">
            <button onclick="savePack()" class="w-full py-3 bg-muji-primary text-white text-sm tracking-widest rounded hover:bg-gray-700">ADD</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="modal-overlay hidden">
        <div class="modal-box p-5 relative">
            <button onclick="closeModal('modal-settings')" class="absolute top-4 right-4 text-muji-secondary"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4 text-muji-text">Rates</h3>
            <div class="mb-4">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-xs text-muji-secondary">Ëá™ÂãïÊõ¥Êñ∞ÂåØÁéá (Last Update: <span id="last-update">--</span>)</p>
                    <button id="btn-update-rates" onclick="fetchRates()" class="text-xs bg-gray-100 text-muji-text px-3 py-2 rounded border border-muji-border hover:bg-white"><i data-lucide="refresh-cw" class="w-3 h-3 inline"></i> Êõ¥Êñ∞</button>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex justify-between bg-gray-50 p-2 rounded border border-muji-border"><span class="font-bold">JPY</span><input id="rate-JPY" type="number" class="w-16 bg-transparent text-right outline-none" onchange="saveConfig()"></div>
                    <div class="flex justify-between bg-gray-50 p-2 rounded border border-muji-border"><span class="font-bold">USD</span><input id="rate-USD" type="number" class="w-16 bg-transparent text-right outline-none" onchange="saveConfig()"></div>
                    <div class="flex justify-between bg-gray-50 p-2 rounded border border-muji-border"><span class="font-bold">KRW</span><input id="rate-KRW" type="number" class="w-16 bg-transparent text-right outline-none" onchange="saveConfig()"></div>
                    <div class="flex justify-between bg-gray-50 p-2 rounded border border-muji-border"><span class="font-bold">EUR</span><input id="rate-EUR" type="number" class="w-16 bg-transparent text-right outline-none" onchange="saveConfig()"></div>
                    <div class="flex justify-between bg-gray-50 p-2 rounded border border-muji-border"><span class="font-bold">HKD</span><input id="rate-HKD" type="number" class="w-16 bg-transparent text-right outline-none" onchange="saveConfig()"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let trips = JSON.parse(localStorage.getItem('tf6_6_trips')) || [];
        let config = JSON.parse(localStorage.getItem('tf6_6_config')) || { rates: { JPY: 0.22, USD: 31.5, KRW: 0.024, EUR: 34.0, HKD: 4.0 }, lastUpdate: '' };
        let defaultPacking = ["Ë≠∑ÁÖß", "Ë∫´ÂàÜË≠â", "ÁèæÈáë", "‰ø°Áî®Âç°", "ÊâãÊ©üÂÖÖÈõªÂô®", "Ëê¨Áî®ËΩâÊé•È†≠", "Ë°åÂãïÈõªÊ∫ê", "ÊèõÊ¥óË°£Áâ©", "Áõ•Ê¥óÁî®ÂìÅ", "ÂÄã‰∫∫Ëó•ÂìÅ", "Èõ®ÂÇò/Èõ®Ë°£", "Èù¢Á¥ô/ÊøïÁ¥ôÂ∑æ"];
        
        let currentTripId = null;
        let activeTab = 'itinerary';
        let activeDayIndex = 0;
        let tempDays = 3;
        let tempImg = null;
        let galleryMode = false;
        let editingItemId = null;
        let editingShopId = null;
        let clockInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderHome();
            loadSettings();
            fetchRates(); // Auto fetch on load
            updateClocks();
            clockInterval = setInterval(updateClocks, 1000);
            document.addEventListener('touchstart', handleTouchStart, false);
            document.addEventListener('touchmove', handleTouchMove, false);
            document.addEventListener('touchend', handleTouchEnd, false);
        });

        // Functions
        function saveData() { localStorage.setItem('tf6_6_trips', JSON.stringify(trips)); }
        function saveConfig() { 
            config.rates.JPY = parseFloat(document.getElementById('rate-JPY').value);
            config.rates.USD = parseFloat(document.getElementById('rate-USD').value);
            config.rates.KRW = parseFloat(document.getElementById('rate-KRW').value);
            config.rates.EUR = parseFloat(document.getElementById('rate-EUR').value);
            config.rates.HKD = parseFloat(document.getElementById('rate-HKD').value);
            localStorage.setItem('tf6_6_config', JSON.stringify(config)); 
        }
        function loadSettings() {
            document.getElementById('rate-JPY').value = config.rates.JPY;
            document.getElementById('rate-USD').value = config.rates.USD;
            document.getElementById('rate-KRW').value = config.rates.KRW;
            document.getElementById('rate-EUR').value = config.rates.EUR;
            document.getElementById('rate-HKD').value = config.rates.HKD || 4.0;
            if(document.getElementById('last-update')) document.getElementById('last-update').innerText = config.lastUpdate || 'Êú™Êõ¥Êñ∞';
        }
        function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function getTrip() { return trips.find(t => t.id === currentTripId); }

        function detectTimezone(location) {
            const loc = location.toLowerCase();
            if (loc.includes('tokyo') || loc.includes('osaka') || loc.includes('japan')) return 'Asia/Tokyo';
            if (loc.includes('seoul') || loc.includes('korea')) return 'Asia/Seoul';
            if (loc.includes('bangkok') || loc.includes('thailand')) return 'Asia/Bangkok';
            if (loc.includes('london') || loc.includes('uk')) return 'Europe/London';
            if (loc.includes('paris') || loc.includes('france')) return 'Europe/Paris';
            if (loc.includes('new york') || loc.includes('usa')) return 'America/New_York';
            return 'Asia/Taipei';
        }

        function updateClocks() {
            const now = new Date();
            document.getElementById('clock-tw').innerText = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Taipei', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const trip = getTrip();
            if(trip) {
                const tz = trip.timezone || 'Asia/Taipei';
                document.getElementById('clock-loc').innerText = now.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                updateActiveItems(tz);
            }
        }

        function updateActiveItems(tz) {
            if(activeTab !== 'itinerary') return;
            const nowString = new Date().toLocaleString('en-US', { timeZone: tz });
            const locDate = new Date(nowString);
            const currentMins = locDate.getHours() * 60 + locDate.getMinutes();
            const items = document.querySelectorAll('.swipe-item');
            items.forEach(el => {
                const timeStr = el.getAttribute('data-time');
                if(timeStr) {
                    const [h, m] = timeStr.split(':').map(Number);
                    const itemMins = h * 60 + m;
                    el.querySelector('.swipe-content').classList.remove('item-active', 'item-past');
                    if (currentMins >= itemMins + 90) el.querySelector('.swipe-content').classList.add('item-past');
                    else if (currentMins >= itemMins && currentMins < itemMins + 90) el.querySelector('.swipe-content').classList.add('item-active');
                }
            });
        }

        function updateCostDisplay() {
            if(!currentTripId) return;
            const trip = getTrip();
            if(!trip) return;
            const total = calculateTotalCost(trip);
            const el = document.getElementById('detail-cost');
            if(el) el.innerText = `TOTAL: NT$ ${total.toLocaleString()}`;
        }

        async function fetchRates() {
            const btn = document.getElementById('btn-update-rates');
            if(btn) btn.innerHTML = '<i data-lucide="loader" class="w-3 h-3 inline animate-spin"></i> Updating...'; lucide.createIcons();
            try { 
                const res = await fetch('https://open.er-api.com/v6/latest/TWD'); const data = await res.json();
                if(data && data.rates) {
                    // Correct Fix: Update Config Object -> Save to LocalStorage -> Update UI
                    config.rates.JPY = 1 / data.rates.JPY; 
                    config.rates.USD = 1 / data.rates.USD; 
                    config.rates.KRW = 1 / data.rates.KRW; 
                    config.rates.EUR = 1 / data.rates.EUR; 
                    config.rates.HKD = 1 / data.rates.HKD;
                    const d = new Date(); 
                    config.lastUpdate = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}`;
                    
                    // SAVE DIRECTLY TO STORAGE (BYPASS READ FROM INPUTS)
                    localStorage.setItem('tf6_6_config', JSON.stringify(config));
                    
                    // THEN UPDATE UI
                    loadSettings(); 
                    updateCostDisplay(); 
                    
                    if(btn) btn.innerHTML = '<i data-lucide="check" class="w-3 h-3 inline"></i> Updated';
                }
            } catch(e) { 
                console.error(e);
                if(btn) btn.innerHTML = '<i data-lucide="x" class="w-3 h-3 inline"></i> Failed'; 
            }
            setTimeout(() => { if(btn) { btn.innerHTML = '<i data-lucide="refresh-cw" class="w-3 h-3 inline"></i> Update Rates'; lucide.createIcons(); } }, 2000);
        }
        function convertToTWD(amount, currency) { if(!amount) return 0; const rate = config.rates[currency] || 1; return currency === 'TWD' ? Math.round(amount) : Math.round(amount * rate); }
        function calcItemTWD() { const c = document.getElementById('item-currency').value; const p = document.getElementById('item-cost').value; document.getElementById('item-twd-display').innerText = convertToTWD(p, c).toLocaleString(); }
        function calcShopTWD() { const c = document.getElementById('shop-curr').value; const p = document.getElementById('shop-price').value; document.getElementById('shop-twd-display').innerText = convertToTWD(p, c).toLocaleString(); }
        function calculateTotalCost(trip) {
            let total = 0;
            if(trip.days) trip.days.forEach(d => { if(d.items) d.items.forEach(i => total += convertToTWD(i.cost, i.currency)) });
            if(trip.shopping) trip.shopping.forEach(s => total += convertToTWD(s.price, s.curr));
            return total;
        }

        function openTrip(id) {
            currentTripId = id;
            document.getElementById('view-home').classList.add('-translate-x-full');
            document.getElementById('view-detail').classList.remove('translate-x-full');
            activeDayIndex = 0; switchTab('itinerary'); renderDetail();
        }
        function goBack() { document.getElementById('view-detail').classList.add('translate-x-full'); document.getElementById('view-home').classList.remove('-translate-x-full'); currentTripId = null; setTimeout(renderHome, 300); }
        function renderDetail() {
            const trip = getTrip(); if(!trip) return;
            document.getElementById('detail-title').innerText = trip.title;
            updateCostDisplay(); updateMarquee();
            if(activeTab==='itinerary') renderItinerary();
            if(activeTab==='shopping') renderShopping();
            if(activeTab==='packing') renderPacking();
        }
        function switchTab(tab) {
            activeTab = tab;
            ['itinerary', 'shopping', 'packing'].forEach(t => {
                const btn = document.getElementById(`nav-${t}`); const div = document.getElementById(`tab-${t}`);
                if (t === tab) { btn.classList.add('active'); div.classList.remove('hidden'); }
                else { btn.classList.remove('active'); div.classList.add('hidden'); }
            });
            renderDetail();
        }

        function renderItinerary() {
            const trip = getTrip(); const dayContainer = document.getElementById('day-selector'); const listContainer = document.getElementById('itinerary-list');
            let daysHtml = '';
            trip.days.forEach((d, idx) => {
                const activeClass = idx === activeDayIndex ? 'bg-white text-muji-text border-muji-border' : 'bg-transparent text-gray-400 border-transparent';
                daysHtml += `<button onclick="activeDayIndex=${idx}; renderItinerary()" class="shrink-0 px-4 py-1.5 rounded text-sm font-bold border transition ${activeClass}">Day ${idx+1}</button>`;
            });
            dayContainer.innerHTML = daysHtml;
            listContainer.innerHTML = '';
            if (!trip.days[activeDayIndex] || trip.days[activeDayIndex].items.length === 0) { listContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-300"><i data-lucide="coffee" class="w-10 h-10 mb-2 opacity-50"></i><p class="text-xs">No Events</p></div>`; } 
            else {
                trip.days[activeDayIndex].items.sort((a,b) => a.time.localeCompare(b.time));
                trip.days[activeDayIndex].items.forEach(item => {
                    const el = document.createElement('div'); el.className = "mb-3 relative";
                    let icon='map-pin';
                    if(item.type==='flight') icon='plane'; if(item.type==='transport') icon='bus'; if(item.type==='food') icon='utensils';
                    if(item.type==='activity') icon='ticket'; if(item.type==='shopping') icon='shopping-bag'; if(item.type==='stay') icon='bed';
                    
                    el.innerHTML = `
                        <div class="timeline-line" style="left:19px;"></div>
                        <div class="absolute left-0 top-1 w-8 h-8 flex items-center justify-center z-10 bg-muji-bg">
                            <div class="w-8 h-8 rounded-full bg-white border border-muji-border text-gray-400 flex items-center justify-center"><i data-lucide="${icon}" class="w-4 h-4"></i></div>
                        </div>
                        <div class="ml-10 p-3 muji-card flex gap-3 cursor-pointer relative item-row" data-time="${item.time}" onclick="openItemModal('${item.id}')">
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-mono text-sm font-bold text-muji-text bg-gray-100 px-1.5 rounded">${item.time}</span>
                                    ${item.cost ? `<span class="text-xs text-muji-secondary font-mono">${item.currency} ${item.cost}</span>` : ''}
                                </div>
                                <h4 class="font-bold text-muji-text text-sm truncate">${item.title}</h4>
                                ${item.loc ? `<div class="text-xs text-gray-400 flex items-center gap-1 mt-0.5"><i data-lucide="map-pin" class="w-3 h-3"></i> ${item.loc}</div>` : ''}
                            </div>
                            <button onclick="event.stopPropagation(); deleteItem('${item.id}')" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>`;
                    listContainer.appendChild(el);
                });
            }
            lucide.createIcons(); updateActiveItems(trip.timezone);
        }

        // --- SHOPPING ---
        function setGalleryMode(enable) { galleryMode = enable; renderShopping(); }
        function renderShopping() {
            const trip = getTrip(); const list = document.getElementById('shopping-list'); list.innerHTML = '';
            if (trip.shopping.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-300"><i data-lucide="shopping-bag" class="w-10 h-10 mb-2 opacity-50"></i><p class="text-xs">No Purchases</p></div>`; } 
            else {
                if(galleryMode) {
                    list.className = "scroll-area gallery-grid";
                    trip.shopping.forEach(item => {
                        const div = document.createElement('div'); div.className = "gallery-item";
                        div.innerHTML = `<img src="${item.img || 'https://via.placeholder.com/150?text=No+Img'}" class="gallery-img" onclick="openShopModal('${item.id}')"><div class="gallery-overlay"><p class="font-bold text-xs truncate">${item.name}</p><button onclick="event.stopPropagation(); deleteShopItem('${item.id}')" class="absolute top-1 right-1 bg-white/80 p-1 rounded-full text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`;
                        list.appendChild(div);
                    });
                } else {
                    list.className = "scroll-area space-y-3";
                    trip.shopping.forEach(item => {
                        const el = document.createElement('div');
                        el.innerHTML = `
                        <div class="muji-card p-3 flex gap-3 items-center item-row" onclick="openShopModal('${item.id}')">
                            <div class="w-12 h-12 bg-gray-100 rounded flex-shrink-0 overflow-hidden border border-muji-border">${item.img ? `<img src="${item.img}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="w-5 h-5 m-3.5 text-gray-400"></i>`}</div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-sm text-muji-text truncate">${item.name}</h4>
                                <div class="text-xs text-muji-secondary mt-0.5">NT$ ${convertToTWD(item.price, item.curr)}</div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteShopItem('${item.id}')" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>`;
                        list.appendChild(el);
                    });
                }
            }
            lucide.createIcons();
        }
        function toggleGalleryMode() { galleryMode = !galleryMode; renderShopping(); }

        function renderPacking() {
            const trip = getTrip(); const list = document.getElementById('packing-list'); list.innerHTML = '';
            trip.packing.forEach(item => {
                const el = document.createElement('div');
                el.innerHTML = `
                <div class="muji-card p-3 flex items-center justify-between mb-2 item-row">
                    <div class="flex items-center gap-3 cursor-pointer flex-1" onclick="togglePack('${item.id}')">
                        <div class="w-5 h-5 rounded border ${item.checked ? 'bg-muji-primary border-muji-primary' : 'border-gray-300'} flex items-center justify-center text-white transition">${item.checked ? '<i data-lucide="check" class="w-3.5 h-3.5"></i>' : ''}</div>
                        <span class="${item.checked ? 'text-gray-300 line-through' : 'text-muji-text text-sm font-medium'}">${item.text}</span>
                    </div>
                    <button onclick="deletePackItem('${item.id}')" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
                list.appendChild(el);
            });
            lucide.createIcons();
        }
        function togglePack(id) { const trip = getTrip(); const item = trip.packing.find(i => i.id === id); item.checked = !item.checked; saveData(); renderPacking(); updateMarquee(); }
        function updateMarquee() {
            const trip = getTrip(); const unchecked = trip.packing.filter(p => !p.checked).map(p => p.text);
            if(unchecked.length > 0) { document.getElementById('marquee-wrapper').classList.remove('hidden'); document.getElementById('marquee-safe').classList.add('hidden'); document.getElementById('marquee-content').innerText = "NOT PACKED: " + unchecked.join(" ¬∑ "); } 
            else { document.getElementById('marquee-wrapper').classList.add('hidden'); document.getElementById('marquee-safe').classList.remove('hidden'); }
        }

        // --- MODALS & CRUD ---
        function handleFab() { if (activeTab === 'itinerary') openItemModal(); if (activeTab === 'shopping') openShopModal(); if (activeTab === 'packing') document.getElementById('modal-pack').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openSettings() { document.getElementById('modal-settings').classList.remove('hidden'); }
        
        function openAddTripModal(isEdit = false) {
            document.getElementById('modal-trip').classList.remove('hidden');
            const trip = isEdit ? getTrip() : null;
            document.getElementById('trip-id').value = trip ? trip.id : '';
            document.getElementById('trip-name').value = trip ? trip.title : '';
            document.getElementById('trip-loc').value = trip ? trip.location : '';
            document.getElementById('trip-date').value = trip ? trip.startDate : new Date().toISOString().split('T')[0];
            tempDays = trip ? trip.days.length : 3;
            document.getElementById('trip-days').innerText = tempDays;
        }
        function changeTripDays(d) { tempDays += d; if (tempDays < 1) tempDays = 1; document.getElementById('trip-days').innerText = tempDays; }
        
        function saveTrip() {
            const id = document.getElementById('trip-id').value; const title = document.getElementById('trip-name').value;
            if(!title) return alert('Name required');
            const loc = document.getElementById('trip-loc').value; const date = document.getElementById('trip-date').value;
            const tz = detectTimezone(loc);
            
            if(id) {
                const trip = trips.find(t => t.id === id); trip.title = title; trip.location = loc; trip.startDate = date; trip.timezone = tz;
                if (tempDays > trip.days.length) for(let i=trip.days.length; i<tempDays; i++) trip.days.push({ items: [] });
            } else {
                const newDays = Array.from({ length: tempDays }, () => ({ items: [] }));
                const newTrip = { id: genId(), title, location: loc, startDate: date, timezone: tz, days: newDays, shopping: [], packing: defaultPacking.map(p => ({ id: genId(), text: p, checked: false })) };
                trips.push(newTrip);
            }
            saveData(); document.getElementById('modal-trip').classList.add('hidden');
            if(currentTripId) renderDetail(); else renderHome();
        }
        function deleteTrip(id) { if(confirm('Delete?')) { trips = trips.filter(t => t.id !== id); saveData(); renderHome(); } }

        function openItemModal(id = null) {
            editingItemId = id; document.getElementById('modal-item').classList.remove('hidden');
            const trip = getTrip();
            document.getElementById('item-day').innerHTML = trip.days.map((_, i) => `<option value="${i}">Day ${i+1}</option>`).join('');
            document.getElementById('item-day').value = activeDayIndex;
            if(id) {
                const item = trip.days[activeDayIndex].items.find(i => i.id === id);
                document.getElementById('item-time').value = item.time; document.getElementById('item-title').value = item.title; document.getElementById('item-loc').value = item.loc; document.getElementById('item-cost').value = item.cost; document.getElementById('item-currency').value = item.currency || 'TWD'; document.getElementById('item-note').value = item.note; selectType(item.type || 'activity'); calcItemTWD();
            } else {
                document.getElementById('item-time').value = '09:00'; document.getElementById('item-title').value = ''; document.getElementById('item-loc').value = ''; document.getElementById('item-cost').value = ''; document.getElementById('item-note').value = ''; selectType('activity'); calcItemTWD();
            }
        }
        function selectType(t) { document.getElementById('item-type').value = t; document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('border-muji-primary', 'text-muji-primary', 'bg-gray-100')); document.getElementById(`type-${t}`).classList.add('border-muji-primary', 'text-muji-primary', 'bg-gray-100'); }
        function saveItem() {
            const dayIdx = parseInt(document.getElementById('item-day').value); const type = document.getElementById('item-type').value; const title = document.getElementById('item-title').value; const time = document.getElementById('item-time').value; const loc = document.getElementById('item-loc').value; const cost = document.getElementById('item-cost').value; const curr = document.getElementById('item-currency').value; const note = document.getElementById('item-note').value;
            if(!title) return alert('Title required');
            const trip = getTrip(); const newItem = { id: editingItemId || genId(), type, title, time, loc, currency: curr, cost, note };
            if(editingItemId) trip.days[activeDayIndex].items = trip.days[activeDayIndex].items.filter(i => i.id !== editingItemId);
            trip.days[dayIdx].items.push(newItem);
            saveData(); document.getElementById('modal-item').classList.add('hidden'); renderItinerary(); renderDetail();
        }
        function deleteItem(id) { if(confirm('Delete?')){ const trip = getTrip(); trip.days[activeDayIndex].items = trip.days[activeDayIndex].items.filter(i => i.id !== id); saveData(); renderItinerary(); renderDetail(); }}
        function modDays(d) { const trip = getTrip(); trip.days.push({items:[]}); saveData(); renderItinerary(); }
        function deleteCurrentDay() { const trip = getTrip(); if(trip.days.length>1 && confirm('Delete Day?')){ trip.days.splice(activeDayIndex,1); if(activeDayIndex>=trip.days.length) activeDayIndex=trip.days.length-1; saveData(); renderItinerary(); }}

        function openShopModal(id=null) {
            editingShopId = id; document.getElementById('modal-shop').classList.remove('hidden');
            if(id) {
                const trip = getTrip(); const item = trip.shopping.find(i => i.id === id);
                document.getElementById('shop-name').value = item.name; document.getElementById('shop-price').value = item.price; document.getElementById('shop-curr').value = item.curr; document.getElementById('shop-loc').value = item.loc || ''; tempImg = item.img; if(tempImg) { document.getElementById('shop-img-preview').src = tempImg; document.getElementById('shop-img-preview').classList.remove('hidden'); document.getElementById('shop-img-placeholder').classList.add('hidden'); }
            } else { document.getElementById('shop-name').value = ''; document.getElementById('shop-price').value = ''; document.getElementById('shop-loc').value = ''; tempImg = null; document.getElementById('shop-img-preview').classList.add('hidden'); document.getElementById('shop-img-placeholder').classList.remove('hidden'); }
            calcShopTWD();
        }
        function handleImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.src = e.target.result; img.onload = function() { const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d'); let w=img.width, h=img.height; const max=600; if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}} cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); tempImg = cvs.toDataURL('image/jpeg',0.7); document.getElementById('shop-img-preview').src = tempImg; document.getElementById('shop-img-preview').classList.remove('hidden'); document.getElementById('shop-img-placeholder').classList.add('hidden'); }}; reader.readAsDataURL(input.files[0]);
            }
        }
        function saveShop() {
            const name = document.getElementById('shop-name').value; const curr = document.getElementById('shop-curr').value; const price = parseFloat(document.getElementById('shop-price').value) || 0; const loc = document.getElementById('shop-loc').value;
            if(!name) return alert('Name required');
            const trip = getTrip(); const newItem = { id: editingShopId || genId(), name, curr, price, loc, img: tempImg };
            if(editingShopId) { const idx = trip.shopping.findIndex(i => i.id === editingShopId); trip.shopping[idx] = newItem; } else { trip.shopping.push(newItem); }
            saveData(); document.getElementById('modal-shop').classList.add('hidden'); renderShopping(); renderDetail();
        }
        function deleteShopItem(id) { if(confirm('Delete?')){ const trip = getTrip(); trip.shopping = trip.shopping.filter(i => i.id !== id); saveData(); renderShopping(); renderDetail(); }}

        function savePack() {
            const name = document.getElementById('pack-name').value; if(name) { const trip = getTrip(); trip.packing.push({ id: genId(), text: name, checked: false }); saveData(); renderPacking(); renderDetail(); document.getElementById('modal-pack').classList.add('hidden'); document.getElementById('pack-name').value = ''; }
        }
        function deletePackItem(id) { if(confirm('Delete?')){ const trip = getTrip(); trip.packing = trip.packing.filter(i => i.id !== id); saveData(); renderPacking(); renderDetail(); }}

        function exportAll() {
            const trip = getTrip(); const c = document.getElementById('export-container');
            c.innerHTML = `<h1 class="text-3xl font-bold text-gray-700 mb-4 font-serif">${trip.title}</h1>`;
            trip.days.forEach((d,i) => { c.innerHTML += `<h3 class="bg-gray-100 p-2 font-bold mt-4 mb-2 text-gray-600">Day ${i+1}</h3>`; d.items.forEach(item => c.innerHTML += `<div class="pl-4 mb-1 border-b border-gray-50 pb-1"><b>${item.time}</b> ${item.title}</div>`); });
            c.innerHTML += `<h3 class="bg-gray-100 p-2 font-bold mt-4 mb-2 text-gray-600">Shopping</h3>`; trip.shopping.forEach(s => c.innerHTML += `<div class="pl-4 mb-1">${s.name} - ${s.curr} ${s.price}</div>`);
            c.style.zIndex = 100; c.style.top = '0';
            html2canvas(c).then(canvas => { const link = document.createElement('a'); link.download = 'TravelFlow_Plan.jpg'; link.href = canvas.toDataURL(); link.click(); c.style.top = '-9999px'; c.style.zIndex = -5; });
        }

        // Swipe (Removed, keeping clean handlers)
        let tStartX=0, tCurrX=0, isSwiping=false;
        function handleTouchStart(e) { tStartX = e.touches[0].clientX; } 
        function handleTouchMove(e) {
            tCurrX = e.touches[0].clientX; const diff = tCurrX - tStartX;
            if(diff > 0 && diff < 150) { 
                e.preventDefault(); 
                const el = e.target.closest('.swipe-content');
                if(el) { el.style.transition = 'none'; el.style.transform = `translateX(${diff}px)`; }
            }
        }
        function handleTouchEnd(e) {
             const diff = tCurrX - tStartX;
             const el = e.target.closest('.swipe-content');
             if(!el) return;
             el.style.transition = 'transform 0.2s';
             el.style.transform = 'translateX(0)';
        }
        
        function renderHome(){
            const container=document.getElementById('trip-list');
            if(!container) return;
            container.innerHTML='';
            if(trips.length===0){container.innerHTML=`<div class="text-center mt-20 text-gray-400 opacity-60"><i data-lucide="cloud" class="w-16 h-16 mx-auto mb-2"></i><p>Â∞öÁÑ°ÊóÖË°åË®àÁï´</p></div>`;return}
            trips.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach(trip=>{const el=document.createElement('div');el.className='mb-3 relative';const dayCount=trip.days.length;const totalCost=calculateTotalCost(trip);el.innerHTML=`<div class="p-4 muji-card flex justify-between items-center cursor-pointer" onclick="openTrip('${trip.id}')"><div class="flex-1"><h3 class="font-serif font-bold text-lg text-muji-text">${trip.title}</h3><p class="text-xs text-muji-secondary mt-1">${dayCount} Days ¬∑ NT$ ${totalCost.toLocaleString()}</p></div><button onclick="event.stopPropagation(); deleteTrip('${trip.id}')" class="p-2 text-gray-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`;container.appendChild(el)});lucide.createIcons()
        }
    </script>
</body>
</html>
